{% extends 'core/base.html' %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load static %}

{% block extra_head %}
<!-- Adicionar CSS espec√≠fico para o PDV aqui -->
<style>
    .form-label-sm {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .form-group-compact {
        margin-bottom: 0.75rem;
    }
    
    .cart-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .cart-summary {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
    }
    
    .cart-footer {
        padding: 1rem;
    }
    
    .cart-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .total-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #198754;
    }
    
    .change-value {
        font-weight: bold;
        color: #198754;
    }
    
    .finish-sale-container {
        margin-top: 1.5rem;
    }
    
    .product-item {
        cursor: pointer;
    }
    
    .product-item:hover {
        background-color: #f8f9fa;
    }
    
    .product-item.selected {
        background-color: #f1fff8;
    }
    
    .product-item.not-selected {
        opacity: 0.6;
    }
    
    .product-item.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #fff4f4;
    }
    
    .code-column {
        width: 100px;
    }
    
    .code-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
    }
    
    .product-code {
        font-family: monospace;
        font-size: 0.875rem;
    }
    
    .customer-suggestion {
        cursor: pointer;
    }
    
    .customer-suggestion:hover {
        background-color: #f8f9fa;
    }
</style>

<!-- Script espec√≠fico para interceptar F1 o mais cedo poss√≠vel 
     Removido para evitar conflitos com pdv.js
-->
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="successToast">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Venda Realizada</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Venda finalizada com sucesso!
            </div>
        </div>
    </div>

    <!-- Modal de Busca R√°pida de Produtos -->
    <div class="modal fade" id="modalBuscaProduto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Busca R√°pida de Produtos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="modal-product-search" placeholder="Digite o c√≥digo ou nome do produto..." autofocus>
                    </div>
                    <div id="modal-search-results" class="list-group" style="max-height: 300px; overflow-y: auto;">
                        <!-- Resultados ser√£o inseridos aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="modal-search-btn">Buscar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div class="modal fade" id="modalFormaPagamento" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Forma de Pagamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="modal-payment-method" class="form-label">Selecione o m√©todo de pagamento</label>
                        <select id="modal-payment-method" class="form-select">
                            <option value="" disabled selected>Selecione o m√©todo de pagamento</option>
                            {% for method in payment_methods %}
                            <option value="{{ method.id }}" data-type="{{ method.name|lower }}">
                                {% if method.name == 'Dinheiro' %}üíµ
                                {% elif method.name == 'Cart√£o de Cr√©dito' %}üí≥
                                {% elif method.name == 'Cart√£o de D√©bito' %}üí≥
                                {% elif method.name == 'PIX' %}üì±
                                {% endif %}
                                {{ method.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="modal-change-container" style="display: none;" class="mt-3">
                        <label for="modal-payment-amount" class="form-label">Valor Pago (R$)</label>
                        <div class="input-group mb-3">
                            <span class="input-group-text">R$</span>
                            <input type="number" id="modal-payment-amount" class="form-control" step="0.01" min="0">
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Troco: <span id="modal-change-amount">R$ 0,00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-payment-method">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Desconto -->
    <div class="modal fade" id="modalDesconto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Aplicar Desconto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-discount" class="form-label">Valor do Desconto (R$)</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="number" id="modal-discount" class="form-control" value="0" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span id="modal-subtotal">R$ 0,00</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Desconto:</span>
                            <span id="modal-discount-display">R$ 0,00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total:</span>
                            <span id="modal-total-after-discount">R$ 0,00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-discount">Aplicar Desconto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta de notifica√ß√£o na parte superior -->
    <div id="saleAlert" class="alert alert-success alert-dismissible fade show d-none" role="alert" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1050; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
        <i class="fas fa-check-circle me-2"></i> <strong>Venda finalizada!</strong> A venda foi registrada com sucesso.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h1 class="h2 mb-0">Ponto de Venda (PDV)</h1>
            <span class="text-muted ms-3 d-none d-md-inline-flex align-items-center">
                <span class="me-2"><kbd class="bg-light text-secondary border">F1</kbd> busca</span>
                <span class="me-2"><kbd class="bg-light text-secondary border">F2</kbd> pagto</span>
                <span class="me-2"><kbd class="bg-light text-secondary border">F3</kbd> desc</span>
                <span class="me-2"><kbd class="bg-light text-secondary border">F4</kbd> fim</span>
            </span>
            <button type="button" class="btn btn-link ms-1 text-muted p-0" data-bs-toggle="modal" data-bs-target="#shortcutsModal" title="Mais atalhos">
                <i class="fas fa-keyboard"></i>
            </button>
        </div>
        <a href="{% url 'sales:sale_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-list me-1"></i> Hist√≥rico de Vendas
        </a>
    </div>

    <div class="row g-4">
        <!-- Produtos e Carrinho -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 py-3">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" id="codigo_produto" class="form-control" placeholder="Digite o c√≥digo do produto..."
                                       name="codigo_produto">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select id="category-filter" class="form-select">
                                <option value="">Todas as categorias</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="barcode-scan" class="btn btn-primary w-100">
                                <i class="fas fa-barcode"></i> Scan
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Produtos -->
                    <div class="product-section p-3">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="products-grid">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 60px">Imagem</th>
                                        <th class="code-column">C√≥digo</th>
                                        <th>Produto</th>
                                        <th style="width: 100px">Pre√ßo</th>
                                        <th style="width: 70px">Estoque</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in products %}
                                    <tr class="product-item" 
                                        data-id="{{ product.id }}" 
                                        data-name="{{ product.name }}" 
                                        data-price="{{ product.price }}" 
                                        data-stock="{{ product.stock_quantity }}"
                                        data-code="{{ product.code }}"
                                        data-barcode="{{ product.barcode }}"
                                        data-category="{{ product.category.name }}">
                                        <td>
                                            {% if product.image %}
                                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                                            {% else %}
                                                <div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                    <i class="fas fa-tshirt text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="code-cell"><span class="product-code" title="{{ product.code }}">{{ product.code|default:"-" }}</span></td>
                                        <td>
                                            <div class="fw-medium">{{ product.name }}</div>
                                            {% if product.has_variations %}
                                            <small class="text-muted">Com varia√ß√µes</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">R$ {{ product.price }}</span>
                                        </td>
                                        <td>
                                            {% if product.stock_quantity <= product.stock_alert_level %}
                                            <span class="badge bg-danger">{{ product.stock_quantity }}</span>
                                            {% else %}
                                            <span class="badge bg-light text-dark border">{{ product.stock_quantity }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <p class="mb-0 text-muted">Nenhum produto encontrado. <a href="{% url 'products:product_create' %}">Cadastre um produto</a>.</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Itens do Carrinho -->
                    <div class="cart-items-section p-3">
                        <h6 class="mb-3">
                            <i class="fas fa-shopping-cart me-2"></i>Itens no Carrinho
                        </h6>
                        <div id="cart-items">
                            <div class="text-center text-muted py-4" id="empty-cart-message">
                                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                <p class="mb-0">Adicione produtos ao carrinho</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resumo e Finaliza√ß√£o -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="cart-wrapper">
                        <div class="cart-summary">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Subtotal:</span>
                                <span class="fw-bold" id="subtotal">R$ 0,00</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Desconto:</span>
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <input type="number" id="desconto" class="form-control" value="0" min="0" step="0.01">
                                    <span class="input-group-text">R$</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total:</span>
                                <span class="total-value" id="total">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <div class="cart-footer">
                            <div class="cart-actions">
                                <div class="form-group-compact">
                                    <label for="payment-method" class="form-label-sm">M√©todo de Pagamento</label>
                                    <select id="metodo_pagamento" class="form-select form-select-sm">
                                        <option value="" disabled selected>Selecione o m√©todo de pagamento</option>
                                        {% for method in payment_methods %}
                                        <option value="{{ method.id }}" data-type="{{ method.name|lower }}">
                                            {% if method.name == 'Dinheiro' %}üíµ
                                            {% elif method.name == 'Cart√£o de Cr√©dito' %}üí≥
                                            {% elif method.name == 'Cart√£o de D√©bito' %}üí≥
                                            {% elif method.name == 'PIX' %}üì±
                                            {% endif %}
                                            {{ method.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div id="change-container" style="display: none;" class="form-group-compact mt-2">
                                    <label for="payment-amount" class="form-label-sm">Valor Pago</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" id="payment-amount" class="form-control" step="0.01" min="0">
                                    </div>
                                    <div class="mt-1">
                                        <small>Troco: <span class="change-value" id="change-amount">R$ 0,00</span></small>
                                    </div>
                                </div>
                                
                                <div class="form-group-compact mt-3">
                                    <label for="customer-search" class="form-label-sm">
                                        <i class="fas fa-user me-1"></i>Cliente (opcional)
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" id="customer-search" class="form-control form-control-sm" placeholder="Digite o nome do cliente...">
                                        <input type="hidden" id="customer-id">
                                        <div id="customer-suggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display: none; z-index: 1000; max-height: 150px; overflow-y: auto;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group-compact mt-3">
                                    <label for="notes" class="form-label-sm">
                                        <i class="fas fa-sticky-note me-1"></i>Observa√ß√µes
                                    </label>
                                    <textarea id="notes" class="form-control form-control-sm" rows="2" placeholder="Adicione observa√ß√µes sobre a venda..."></textarea>
                                </div>

                                <div class="finish-sale-container">
                                    <div class="d-grid">
                                        <button id="btn-finalizar" class="btn btn-success">
                                            <i class="fas fa-check-circle me-1"></i> Finalizar Venda
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Quantidade -->
    <div class="modal fade" id="modalQuantidade" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-product-name">Nome do Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="add-to-cart-form" onsubmit="document.getElementById('add-to-cart').click(); return false;">
                <div class="modal-body">
                    <p class="mb-3">Pre√ßo: <span class="fw-bold" id="modal-product-price">R$ 0,00</span></p>
                    <p class="mb-3">Estoque dispon√≠vel: <span class="fw-bold" id="modal-product-stock">0</span></p>
                    
                    <div class="mb-3">
                        <label for="product-quantity" class="form-label">Quantidade</label>
                        <div class="input-group">
                                <button type="button" class="btn btn-outline-secondary" id="decrease-qty">-</button>
                            <input type="number" id="product-quantity" class="form-control text-center" value="1" min="1">
                                <button type="button" class="btn btn-outline-secondary" id="increase-qty">+</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="add-to-cart">Adicionar ao Carrinho</button>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Venda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Total a pagar: <span class="fw-bold" id="confirm-total">R$ 0,00</span></p>
                    <p>M√©todo de pagamento: <span id="confirm-payment-method">Dinheiro</span></p>
                    <p id="confirm-customer-container">Cliente: <span id="confirm-customer">-</span></p>
                    
                    <div class="mt-3 form-check">
                        <input class="form-check-input" type="checkbox" id="send-whatsapp-receipt" disabled>
                        <label class="form-check-label" for="send-whatsapp-receipt">
                            <i class="fab fa-whatsapp text-success me-1"></i> Enviar recibo por WhatsApp
                        </label>
                        <small class="form-text text-muted d-block">
                            Apenas dispon√≠vel se o cliente tiver telefone cadastrado
                        </small>
                    </div>
                    
                    <div class="alert alert-success mt-3" id="sale-success-message" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i> Venda realizada com sucesso!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a class="btn btn-outline-primary" style="display: none;" id="view-sales-history" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i> Fechar
                    </a>
                    <button type="button" class="btn btn-primary" id="confirm-sale">Confirmar Venda</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Atalhos de Teclado -->
    <div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shortcutsModalLabel">
                        <i class="fas fa-keyboard me-2"></i> Atalhos de Teclado
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 100px">Tecla</th>
                                    <th>Fun√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><kbd>F1</kbd></td>
                                    <td>Focar na busca de produtos</td>
                                </tr>
                                <tr>
                                    <td><kbd>F2</kbd></td>
                                    <td>Focar no m√©todo de pagamento</td>
                                </tr>
                                <tr>
                                    <td><kbd>F3</kbd></td>
                                    <td>Focar no campo de desconto</td>
                                </tr>
                                <tr>
                                    <td><kbd>F4</kbd></td>
                                    <td>Finalizar venda</td>
                                </tr>
                                <tr>
                                    <td><kbd>‚Üë</kbd> / <kbd>‚Üì</kbd></td>
                                    <td>Navegar entre produtos</td>
                                </tr>
                                <tr>
                                    <td><kbd>Enter</kbd></td>
                                    <td>Selecionar produto / confirmar</td>
                                </tr>
                                <tr>
                                    <td><kbd>Esc</kbd></td>
                                    <td>Limpar campo de busca</td>
                                </tr>
                                <tr>
                                    <td><kbd>Alt</kbd>+<kbd>X</kbd></td>
                                    <td>Limpar carrinho</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SOLU√á√ÉO DEFINITIVA PARA BLOQUEAR F1-F12 DE ABRIR P√ÅGINAS PADR√ÉO DO BROWSER
        // Interceptar as teclas de fun√ß√£o o mais cedo poss√≠vel
        // REMOVIDO: Substitu√≠do pelo c√≥digo em pdv.js
        /*
        document.addEventListener('keydown', handleFunctionKeys, true);
        window.addEventListener('keydown', handleFunctionKeys, true);
        
        function handleFunctionKeys(e) {
            // ... c√≥digo existente removido ...
        }
        */
        
        // Array para armazenar itens do carrinho
        let cart = [];
        
        // Fun√ß√£o para verificar se j√° existe um produto no carrinho e retornar seu √≠ndice
        function findProductInCart(productId) {
            return cart.findIndex(item => item.id === productId);
        }

        // Fun√ß√£o para obter a quantidade total de um produto no carrinho
        function getProductQuantityInCart(productId) {
            const index = findProductInCart(productId);
            return index >= 0 ? cart[index].quantity : 0;
        }

        // Fun√ß√£o para renderizar os itens do carrinho
        function renderCartItems() {
            const cartItems = document.getElementById('cart-items');
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center text-muted py-4" id="empty-cart-message">
                        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                        <p class="mb-0">Adicione produtos ao carrinho</p>
                    </div>
                `;
                return;
            }
            
            let cartHtml = '';
            cart.forEach((item, index) => {
                const qtdHighlight = item.quantity > 1 ? 'bg-primary text-white' : 'bg-light text-dark';
                
                cartHtml += `
                    <div class="cart-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded bg-white shadow-sm" 
                         id="cart-item-${item.id}" data-product-id="${item.id}">
                        <div>
                            <div class="fw-medium mb-1">${item.name}</div>
                            <div class="d-flex align-items-center text-muted small">
                                <span class="badge ${qtdHighlight} me-2">${item.quantity}x</span>
                                <span>R$ ${item.price}</span>
                                <span class="mx-1">‚Ä¢</span>
                                <span class="text-success fw-bold">Total: R$ ${(item.quantity * item.price).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="small text-muted mt-1">C√≥digo: ${item.code}</div>
                        </div>
                        <div class="d-flex">
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="adjustCartItemQuantity(${index}, -1)" title="Diminuir quantidade">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="adjustCartItemQuantity(${index}, 1)" title="Aumentar quantidade">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeCartItem(${index})" title="Remover item">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartHtml;
        }
        
        // Fun√ß√£o para ajustar a quantidade de um item no carrinho
        function adjustCartItemQuantity(index, delta) {
            if (index < 0 || index >= cart.length) return;
            
            const item = cart[index];
            const newQuantity = item.quantity + delta;
            
            if (newQuantity <= 0) {
                // Se nova quantidade for zero ou negativa, remover o item
                removeCartItem(index);
                return;
            }
            
            // Verificar estoque antes de aumentar a quantidade
            if (delta > 0) {
                fetch("{% url 'sales:check_stock' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: newQuantity
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Estoque dispon√≠vel, atualizar quantidade
                        item.quantity = newQuantity;
                        renderCartItems();
                        updateTotals();
                        
                        // Destacar o item atualizado
                        highlightCartItem(item.id);
                        
                        // Mostrar toast de confirma√ß√£o
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true
                        });
                        
                        Toast.fire({
                            icon: 'success',
                            title: `Quantidade atualizada (${newQuantity}x)`
                        });
                    } else {
                        // Estoque insuficiente
                        Swal.fire({
                            icon: 'error',
                            title: 'Estoque Insuficiente',
                            text: data.error || `Estoque insuficiente. Dispon√≠vel: ${data.available || 0}`,
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar estoque:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: 'Ocorreu um erro ao verificar o estoque. Tente novamente.',
                        confirmButtonText: 'OK'
                    });
                });
            } else {
                // Reduzir quantidade n√£o precisa verificar estoque
                item.quantity = newQuantity;
                renderCartItems();
                updateTotals();
                
                // Destacar o item atualizado
                highlightCartItem(item.id);
                
                // Mostrar toast de confirma√ß√£o
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1000,
                    timerProgressBar: true
                });
                
                Toast.fire({
                    icon: 'success',
                    title: `Quantidade atualizada (${newQuantity}x)`
                });
            }
        }
        
        // Fun√ß√£o para calcular e atualizar os totais
            function updateTotals() {
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            const discountEl = document.getElementById('desconto');
            
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.quantity * item.price;
            });
            
                const discount = parseFloat(discountEl.value) || 0;
            const total = Math.max(0, subtotal - discount);
                
                subtotalEl.textContent = `R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            totalEl.textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
        // Atualizar o total no modal de confirma√ß√£o
        if (document.getElementById('confirm-total')) {
            document.getElementById('confirm-total').textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }
    }
        
        // Fun√ß√£o para remover item do carrinho
        window.removeCartItem = function(index) {
            if (index >= 0 && index < cart.length) {
                cart.splice(index, 1);
                renderCartItems();
                updateTotals();
            }
        };

        // Garantir que o evento seja configurado quando o documento estiver totalmente carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Remover event listener anterior se existir (com tratamento de erro)
            try {
                document.removeEventListener('keydown', handleShortcutKeys);
            } catch (e) {
                // Ignora o erro se o listener n√£o existir
            }
            
            // Adicionar event listener global para atalhos
            document.addEventListener('keydown', handleShortcutKeys);
            
            // Focar no campo de busca ao carregar a p√°gina
            const searchInput = document.getElementById('codigo_produto');
            searchInput.value = '';
            searchInput.focus();

            // Configurar a busca de produtos
            setupProductSearch();

            // Adicionar evento de clique direto nos produtos para garantir funcionamento
            const allProductRows = document.querySelectorAll('#products-grid tbody tr.product-item');
            allProductRows.forEach(row => {
                row.addEventListener('click', function() {
                    // Verificar se tem estoque
                    if (this.classList.contains('out-of-stock')) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Produto Indispon√≠vel',
                            text: 'Este produto est√° sem estoque.',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
                    
                    // Limpar sele√ß√µes anteriores
                    const selectedRows = document.querySelectorAll('.selected');
                    selectedRows.forEach(r => {
                        r.classList.remove('selected');
                        r.style.outline = '';
                    });
                    
                    // Selecionar este produto
                    this.classList.add('selected');
                    this.style.outline = '2px solid #198754';
                    
                    // Abrir modal de quantidade
                    selectProduct(this);
                });
            });

            // Configurar o m√©todo de pagamento para mostrar o campo de valor pago quando Dinheiro for selecionado
            const paymentMethodSelect = document.getElementById('metodo_pagamento');
            paymentMethodSelect.addEventListener('change', function() {
                console.log('M√©todo de pagamento alterado:', this.options[this.selectedIndex].textContent.trim());
                const paymentMethod = this.options[this.selectedIndex].textContent.trim();
                const changeContainer = document.getElementById('change-container');
                
                if (paymentMethod.includes('Dinheiro')) {
                    changeContainer.style.display = 'block';
                    document.getElementById('payment-amount').focus();
                } else {
                    changeContainer.style.display = 'none';
                }
            });
            
            // Configurar o c√°lculo de troco
            document.getElementById('payment-amount').addEventListener('input', function() {
                const totalText = document.getElementById('total').textContent.trim();
                const total = parseFloat(totalText.replace('R$', '').replace(',', '.')) || 0;
                const paymentAmount = parseFloat(this.value) || 0;
                const changeAmount = Math.max(0, paymentAmount - total);
                
                console.log('Calculando troco:', total, paymentAmount, changeAmount);
                document.getElementById('change-amount').textContent = `R$ ${changeAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            });

            // Configurar a busca de clientes por AJAX
            const customerSearch = document.getElementById('customer-search');
            const customerSuggestions = document.getElementById('customer-suggestions');
            const customerId = document.getElementById('customer-id');
            
            customerSearch?.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                if (searchTerm.length < 2) {
                    customerSuggestions.style.display = 'none';
                    customerId.value = '';
                    this.classList.remove('is-valid');
                        return;
                    }
                    
                // Buscar clientes via AJAX
                fetch(`/sistema/clientes/busca-ajax/?term=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            // Mostrar sugest√µes
                            let suggestionsHtml = '';
                            data.results.forEach(customer => {
                                suggestionsHtml += `
                                    <div class="customer-suggestion p-2 border-bottom" 
                                        data-id="${customer.id}" 
                                        data-name="${customer.name}"
                                        data-has-phone="${customer.has_phone}">
                                        <div class="fw-medium">${customer.text}</div>
                                    </div>
                                `;
                            });
                            
                            customerSuggestions.innerHTML = suggestionsHtml;
                            customerSuggestions.style.display = 'block';
                            
                            // Adicionar evento de clique √†s sugest√µes
                            document.querySelectorAll('.customer-suggestion').forEach(suggestion => {
                                suggestion.addEventListener('click', function() {
                                    const id = this.getAttribute('data-id');
                                    const name = this.getAttribute('data-name');
                                    const hasPhone = this.getAttribute('data-has-phone') === 'true';
                                    
                                    customerSearch.value = name;
                                    customerId.value = id;
                                    customerSuggestions.style.display = 'none';
                                    customerSearch.classList.add('is-valid');
                                    
                                    // Atualizar modal de confirma√ß√£o
                                    if (document.getElementById('confirm-customer')) {
                                        document.getElementById('confirm-customer').textContent = name;
                                        document.getElementById('confirm-customer-container').style.display = 'block';
            } else {
                                        document.getElementById('confirm-customer').textContent = '-';
                                        document.getElementById('confirm-customer-container').style.display = 'block';
            }
                                    
                                    // Abrir o modal de confirma√ß√£o
                                    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                                    modal.show();
            } else {
                                        // Nenhum cliente encontrado - oferecer op√ß√£o de cadastro
                                        customerSuggestions.innerHTML = `
                                            <div class="p-2 text-primary new-customer-option" style="cursor: pointer;">
                                                <i class="fas fa-plus-circle me-1"></i> Cadastrar novo cliente "${searchTerm}"
                                            </div>
                                        `;
                                        customerSuggestions.style.display = 'block';
                                        
                                        // Adicionar evento para cadastro de novo cliente
                                        document.querySelector('.new-customer-option')?.addEventListener('click', function() {
                                            window.open('/sistema/clientes/novo/?name=' + encodeURIComponent(searchTerm), '_blank');
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error('Erro na busca de clientes:', error);
                                    customerSuggestions.style.display = 'none';
                                });
            });
            
            // Fechar sugest√µes ao clicar fora
            document.addEventListener('click', function(e) {
                if (!customerSearch?.contains(e.target) && !customerSuggestions?.contains(e.target)) {
                    customerSuggestions.style.display = 'none';
                }
            });

            // Adicionar bot√£o para limpar a sele√ß√£o de cliente
            const customerField = document.querySelector('.position-relative');
            const clearButton = document.createElement('button');
            clearButton.className = 'btn btn-sm btn-link position-absolute top-50 end-0 translate-middle-y text-muted';
            clearButton.innerHTML = '<i class="fas fa-times"></i>';
            clearButton.style.display = 'none';
            clearButton.style.zIndex = '1001';
            clearButton.title = 'Limpar cliente selecionado';
            
            customerField.appendChild(clearButton);
            
            // Mostrar/esconder o bot√£o limpar quando necess√°rio
            customerSearch.addEventListener('input', function() {
                clearButton.style.display = this.value ? 'block' : 'none';
            });
            
            // Limpar sele√ß√£o ao clicar no bot√£o
            clearButton.addEventListener('click', function() {
                customerSearch.value = '';
                customerId.value = '';
                customerSearch.classList.remove('is-valid');
                customerSuggestions.style.display = 'none';
                clearButton.style.display = 'none';
                customerSearch.focus();
                
                // Atualizar modal de confirma√ß√£o
                if (document.getElementById('confirm-customer')) {
                    document.getElementById('confirm-customer').textContent = '-';
                }
                
                // Desabilitar op√ß√£o de WhatsApp
                document.getElementById('send-whatsapp-receipt').disabled = true;
                document.getElementById('send-whatsapp-receipt').checked = false;
            });
            
            // Fechar sugest√µes ao clicar fora
            document.addEventListener('click', function(e) {
                if (!customerSearch.contains(e.target) && !customerSuggestions.contains(e.target)) {
                    customerSuggestions.style.display = 'none';
                }
            });

            // Adicionar estilo CSS para a sugest√£o ativa
            const style = document.createElement('style');
            style.textContent = `
                .customer-suggestion.active {
                    background-color: #f8f9fa;
                    border-left: 3px solid #198754;
                }
                .customer-suggestion:hover {
                    background-color: #f8f9fa;
                }
                #customer-search.is-valid {
                    background-color: #f8fff9;
                    border-color: #198754;
                }
            `;
            document.head.appendChild(style);

            // Configurar o modal de quantidade
            setupQuantityModal();
        });

        // Fun√ß√£o para configurar a busca de produtos
        function setupProductSearch() {
            const searchInput = document.getElementById('codigo_produto');
            const productsTable = document.getElementById('products-grid');
            let selectedRow = null;

            // Marcar produtos sem estoque
            const allRows = productsTable.querySelectorAll('tbody tr.product-item');
            allRows.forEach(row => {
                const stock = parseInt(row.getAttribute('data-stock'));
                if (stock <= 0) {
                    row.classList.add('out-of-stock');
                }
            });

            // Fun√ß√£o para limpar todas as sele√ß√µes
            function clearAllSelections() {
                const allRows = productsTable.querySelectorAll('tbody tr.product-item');
                allRows.forEach(row => {
                    row.classList.remove('selected');
                    row.classList.remove('not-selected');
                    row.style.outline = '';
                });
                selectedRow = null;
            }

            // Fun√ß√£o para resetar e mostrar todos os produtos
            function resetProductDisplay() {
                // Mostrar todos os produtos
                const allRows = productsTable.querySelectorAll('tbody tr.product-item');
                allRows.forEach(row => {
                    row.style.display = '';
                });
                
                // Limpar sele√ß√µes
                clearAllSelections();
                
                // Limpar campo de busca
                searchInput.value = '';
            }

            // Evento de input para filtrar produtos
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                // Limpar sele√ß√£o anterior e resetar exibi√ß√£o
                clearAllSelections();
                
                // Reset completo se a busca estiver vazia
                    if (!searchTerm) {
                    resetProductDisplay();
                    return;
                }
                
                // Filtrar produtos
                const rows = productsTable.querySelectorAll('tbody tr.product-item');
                let visibleRows = [];
                let exactMatch = null;
                
                rows.forEach(row => {
                    const name = row.getAttribute('data-name').toLowerCase();
                    const code = row.getAttribute('data-code').toLowerCase();
                    const barcode = row.getAttribute('data-barcode')?.toLowerCase() || '';
                    
                    // Verificar correspond√™ncia exata com c√≥digo
                    if (code === searchTerm) {
                        exactMatch = row;
                    }
                    
                    if (name.includes(searchTerm) || code.includes(searchTerm) || barcode.includes(searchTerm)) {
                        row.style.display = '';
                        visibleRows.push(row);
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Se houver correspond√™ncia exata, selecionar esse produto
                if (exactMatch) {
                    // Verificar se o produto tem estoque antes de selecionar
                    if (exactMatch.classList.contains('out-of-stock')) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Produto Indispon√≠vel',
                            text: 'Este produto est√° sem estoque.',
                            confirmButtonText: 'OK'
                        });
                        // Destacar visualmente, mas n√£o selecionar para adicionar
                        exactMatch.classList.add('selected');
                        exactMatch.style.outline = '2px solid #dc3545'; // Borda vermelha
                        exactMatch.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        selectedRow = exactMatch;
                        selectedRow.classList.add('selected');
                        selectedRow.style.outline = '2px solid #198754';
                        selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        
                        // Se for uma correspond√™ncia exata, abrir o modal automaticamente
                        if (searchTerm.length > 2) {
                            selectProduct(exactMatch);
                        }
                    }
                }
                // Caso contr√°rio, destacar o primeiro produto vis√≠vel se houver apenas um
                else if (visibleRows.length === 1) {
                    // Verificar se o produto tem estoque antes de selecionar
                    if (!visibleRows[0].classList.contains('out-of-stock')) {
                        selectedRow = visibleRows[0];
                        selectedRow.classList.add('selected');
                        selectedRow.style.outline = '2px solid #198754';
                        selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                
                // Marcar outros produtos como n√£o selecionados se houver sele√ß√£o
                if (selectedRow) {
                    visibleRows.forEach(row => {
                        if (row !== selectedRow) {
                            row.classList.add('not-selected');
                    }
                });
            }
            });

            // Evento de tecla para o campo de busca
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    // Selecionar produto destacado ou primeiro vis√≠vel
                    const rows = Array.from(productsTable.querySelectorAll('tbody tr.product-item')).filter(row => row.style.display !== 'none');
                    
                    if (rows.length > 0) {
                        // Se n√£o h√° produto selecionado, selecione o primeiro que tenha estoque
                        let selectedProduct = selectedRow;
                        
                        if (!selectedProduct) {
                            // Buscar o primeiro produto com estoque
                            selectedProduct = rows.find(row => !row.classList.contains('out-of-stock'));
                            
                            if (!selectedProduct) {
                                // Se nenhum produto tem estoque, mostrar mensagem
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Produtos Indispon√≠veis',
                                    text: 'Nenhum dos produtos encontrados possui estoque dispon√≠vel.',
                                    confirmButtonText: 'OK'
                                });
                                return;
                            }
                        }
                        
                        // Verificar se o produto selecionado tem estoque
                        if (selectedProduct.classList.contains('out-of-stock')) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Produto Indispon√≠vel',
                                text: 'Este produto est√° sem estoque.',
                                confirmButtonText: 'OK'
                            });
                            return;
                        }
                        
                        // Abrir modal com o produto selecionado
                        selectProduct(selectedProduct);
                        
                        // Limpar campo ap√≥s selecionar para a pr√≥xima busca
                        this.value = '';
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateProductList('down');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateProductList('up');
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    resetProductDisplay();
                }
            });
            
            // Adicionar eventos de clique aos produtos
            const productItems = productsTable.querySelectorAll('tbody tr.product-item');
            productItems.forEach(item => {
                // Remover qualquer evento de clique existente
                item.removeEventListener('click', handleProductClick);
                
                // Adicionar novo evento de clique
                item.addEventListener('click', handleProductClick);
            });
        }

        // Fun√ß√£o de handler para clique nos produtos
        function handleProductClick() {
            // N√£o selecionar produtos sem estoque
            if (this.classList.contains('out-of-stock')) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Produto Indispon√≠vel',
                    text: 'Este produto est√° sem estoque.',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Limpar sele√ß√µes anteriores
            clearAllSelections();
            
            // Selecionar o produto clicado
            this.classList.add('selected');
            this.style.outline = '2px solid #198754';
            selectedRow = this;
            
            // Selecionar o produto
            selectProduct(this);
        }
        
        // Fun√ß√£o para navegar na lista de produtos com as setas
        function navigateProductList(direction) {
            const rows = Array.from(document.querySelectorAll('#products-grid tbody tr.product-item')).filter(row => row.style.display !== 'none');
            
            if (rows.length === 0) return;
            
            let selectedIndex = -1;
            
            // Encontrar √≠ndice do produto selecionado
            rows.forEach((row, index) => {
                if (row.classList.contains('selected')) {
                    selectedIndex = index;
                    row.classList.remove('selected');
                    row.style.outline = '';
                }
                // Remover classe not-selected de todos
                row.classList.remove('not-selected');
            });
            
            if (direction === 'down') {
                selectedIndex = (selectedIndex + 1) % rows.length;
            } else if (direction === 'up') {
                selectedIndex = selectedIndex <= 0 ? rows.length - 1 : selectedIndex - 1;
            }
            
            // Aplicar sele√ß√£o ao produto correto
            rows[selectedIndex].classList.add('selected');
            rows[selectedIndex].style.outline = '2px solid #198754';
            rows[selectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Marcar outros produtos como n√£o selecionados
            rows.forEach((row, index) => {
                if (index !== selectedIndex) {
                    row.classList.add('not-selected');
                }
            });
        }
        
        // Fun√ß√£o para selecionar um produto e abrir o modal de quantidade
        function selectProduct(productRow) {
            // N√£o selecionar produtos sem estoque
            if (productRow.classList.contains('out-of-stock')) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Produto Indispon√≠vel',
                    text: 'Este produto est√° sem estoque.',
                    confirmButtonText: 'OK'
                });
                return;
            }

            const id = productRow.getAttribute('data-id');
            const name = productRow.getAttribute('data-name');
        const price = parseFloat(productRow.getAttribute('data-price'));
        const stock = parseInt(productRow.getAttribute('data-stock'));
        const code = productRow.getAttribute('data-code');
        
        // Atualizar dados no modal
        document.getElementById('modal-product-name').textContent = name;
        document.getElementById('modal-product-price').textContent = `R$ ${price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('modal-product-stock').textContent = stock;
        document.getElementById('product-quantity').value = 1;
        
        // Armazenar dados do produto selecionado para adicionar ao carrinho
        const addToCartBtn = document.getElementById('add-to-cart');
        addToCartBtn.setAttribute('data-id', id);
        addToCartBtn.setAttribute('data-name', name);
        addToCartBtn.setAttribute('data-price', price);
        addToCartBtn.setAttribute('data-code', code);
        
        // Remover qualquer backdrop anterior para evitar escurecimento progressivo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
        
        // Abrir o modal e impedir disparos repetidos
        const quantityModal = document.getElementById('modalQuantidade');
        // Verificar se o modal j√° est√° sendo mostrado para evitar aberturas repetidas
        if (!quantityModal.classList.contains('show')) {
            const modal = new bootstrap.Modal(quantityModal);
            modal.show();
            
            // Aguardar a anima√ß√£o do modal terminar antes de focar no campo de quantidade
            setTimeout(() => {
                document.getElementById('product-quantity').focus();
                document.getElementById('product-quantity').select();
            }, 300);
        }
    }

    // Fun√ß√£o para gerenciar atalhos de teclado
    function handleShortcutKeys(e) {
        // Evitar atalhos se algum modal estiver aberto
        if (document.querySelector('.modal.show')) {
            return;
        }
        
        // F1 - Focar no campo de busca de produtos
        if (e.key === 'F1') {
            e.preventDefault();
            document.getElementById('codigo_produto').focus();
            document.getElementById('codigo_produto').select();
            return false;
        }
        
        // F2 - Abrir o modal de m√©todo de pagamento
        else if (e.key === 'F2') {
            e.preventDefault();
            abrirModalFormaPagamento();
            return false;
        }
        
        // F3 - Abrir modal de desconto
        else if (e.key === 'F3') {
            e.preventDefault();
            abrirModalDesconto();
            return false;
        }
        
        // F4 - Finalizar a venda
        else if (e.key === 'F4') {
            e.preventDefault();
            finalizarVenda();
            return false;
        }
    }

    // Adicionar o evento de escuta de teclas ao documento
    document.addEventListener('keydown', handleShortcutKeys);

    // Fun√ß√£o para verificar o estoque de todos os produtos no carrinho
    function verifyAllProductsStock() {
        return new Promise((resolve, reject) => {
            if (cart.length === 0) {
                resolve({ success: true });
                return;
            }

            // Criar uma lista de verifica√ß√µes de estoque
            const stockChecks = cart.map(item => {
                return fetch("{% url 'sales:check_stock' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        product_id: item.id,
                        quantity: item.quantity
                    })
                }).then(response => response.json());
            });

            // Executar todas as verifica√ß√µes em paralelo
            Promise.all(stockChecks)
                .then(results => {
                    // Verificar se algum produto tem estoque insuficiente
                    const stockErrors = [];
                    results.forEach((result, index) => {
                        if (!result.success) {
                            const item = cart[index];
                            stockErrors.push({
                                product: item.name,
                                error: result.error,
                                available: result.available,
                                requested: item.quantity
                            });
                        }
                    });

                    if (stockErrors.length > 0) {
                        resolve({ 
                            success: false, 
                            errors: stockErrors 
                        });
                    } else {
                        resolve({ success: true });
                    }
                })
                .catch(error => {
                    reject(error);
                });
        });
    }

    // Configurar o bot√£o finalizar venda
    document.getElementById('btn-finalizar').addEventListener('click', function(e) {
            // Verificar se h√° itens no carrinho
            if (cart.length === 0) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Carrinho Vazio',
                text: 'Adicione produtos ao carrinho antes de finalizar a venda.',
                confirmButtonText: 'OK'
            });
            return false;
        }
        
        // Verificar m√©todo de pagamento
        const paymentMethodEl = document.getElementById('metodo_pagamento');
        const paymentMethod = paymentMethodEl.options[paymentMethodEl.selectedIndex];
        if (!paymentMethod || paymentMethod.value === '') {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'M√©todo de Pagamento',
                text: 'Selecione um m√©todo de pagamento antes de finalizar.',
                confirmButtonText: 'OK'
            });
            paymentMethodEl.focus();
            return false;
        }
        
        // Primeiro verificar o estoque de todos os produtos no carrinho
        Swal.fire({
            title: 'Verificando estoque...',
            text: 'Por favor, aguarde enquanto verificamos o estoque dos produtos.',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
                
                verifyAllProductsStock()
                    .then(result => {
                        Swal.close();
                        
                        if (result.success) {
                            // Tudo ok, prosseguir com a finaliza√ß√£o da venda
                            // Preencher os dados no modal de confirma√ß√£o
                            document.getElementById('confirm-total').textContent = document.getElementById('total').textContent;
                            document.getElementById('confirm-payment-method').textContent = paymentMethod.textContent.trim();
                            
                            // Cliente selecionado
                            const customerId = document.getElementById('customer-id').value;
                            const customerName = document.getElementById('customer-search').value;
                            if (customerId && customerName) {
                                document.getElementById('confirm-customer').textContent = customerName;
                                document.getElementById('confirm-customer-container').style.display = 'block';
                } else {
                                document.getElementById('confirm-customer').textContent = '-';
                                document.getElementById('confirm-customer-container').style.display = 'block';
                }
                            
                            // Abrir o modal de confirma√ß√£o
                            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                            modal.show();
            } else {
                            // H√° problemas de estoque, mostrar mensagem para o usu√°rio
                            let errorMessage = "Existem produtos com estoque insuficiente:\n\n";
                            result.errors.forEach(error => {
                                errorMessage += `‚Ä¢ ${error.product}: Dispon√≠vel ${error.available}, Requisitado ${error.requested}\n`;
                            });
                            
                            Swal.fire({
                                icon: 'error',
                                title: 'Estoque Insuficiente',
                                html: errorMessage.replace(/\n/g, '<br>'),
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.close();
                        console.error('Erro ao verificar estoque:', error);
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: 'Ocorreu um erro ao verificar o estoque. Tente novamente.',
                            confirmButtonText: 'OK'
                        });
                    });
            }
        });
    });

    // Configurar o bot√£o de confirmar venda no modal
    document.getElementById('confirm-sale').addEventListener('click', function() {
        // Desabilitar o bot√£o durante o processamento
            this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processando...';
        
        // Preparar os dados da venda
        const items = [];
        cart.forEach(item => {
            items.push({
                    product_id: item.id,
                    quantity: item.quantity,
                    price: item.price
            });
        });
        
        const saleData = {
            customer_id: document.getElementById('customer-id').value || null,
            payment_method: document.getElementById('metodo_pagamento').value,
            items: items,
            discount: parseFloat(document.getElementById('desconto').value) || 0,
            notes: document.getElementById('notes').value || '',
            send_whatsapp: document.getElementById('send-whatsapp-receipt').checked
        };

        // Enviar a venda para o servidor via AJAX
        fetch("{% url 'sales:confirm_sale' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(saleData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                    throw new Error(data.error || 'Erro ao processar a venda');
                    });
                }
                return response.json();
            })
            .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Erro ao processar a venda');
            }
            console.log("Venda registrada com sucesso:", data);
            
            // Limpar o PDV imediatamente ap√≥s o sucesso
            resetPDV();
                
                // Mostrar mensagem de sucesso
            document.getElementById('sale-success-message').style.display = 'block';
            
            // Esconder bot√£o de confirmar e mostrar bot√£o de fechar
            this.style.display = 'none';
            document.getElementById('view-sales-history').style.display = 'inline-block';
            document.getElementById('view-sales-history').href = "{% url 'sales:sale_list' %}";
            
            // Mostrar toast de confirma√ß√£o
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
            
            // Ativar fechamento do modal com Enter
            activateSuccessCloseWithEnter();
            
            // Se tiver uma URL de recibo e o cliente escolheu enviar por WhatsApp
            if (data.has_phone && saleData.send_whatsapp) {
                    setTimeout(() => {
                    window.open(`/sistema/vendas/${data.sale_id}/whatsapp/`, '_blank');
                }, 500);
            }

            // Fechar o modal ap√≥s um breve delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
                
                // Mostrar alerta de sucesso
                Swal.fire({
                    icon: 'success',
                    title: 'Venda Realizada',
                    text: 'A venda foi registrada com sucesso!',
                    timer: 2000,
                    showConfirmButton: false
                });
            }, 500);
            })
            .catch(error => {
            console.error('Erro:', error);
            
            // Fechar o modal de confirma√ß√£o
            bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
            
            // Verificar se o erro √© relacionado a estoque
            const errorMessage = error.message || 'Ocorreu um erro ao processar a venda. Por favor, tente novamente.';
            
            if (errorMessage.includes('Estoque insuficiente')) {
                // Erro de estoque - vamos verificar novamente o estoque de todos os produtos
                verifyAllProductsStock()
                    .then(result => {
                        // Atualizar os dados do carrinho com base nas informa√ß√µes mais recentes
                        if (!result.success) {
                            // Formatar mensagem de erro
                            let errorHtml = '<div class="text-start mb-3">Os seguintes produtos t√™m problemas de estoque:</div><ul class="text-start">';
                            
                            result.errors.forEach(error => {
                                errorHtml += `<li><strong>${error.product}</strong>: Dispon√≠vel ${error.available}, Requisitado ${error.requested}</li>`;
                                
                                // Atualizar o carrinho automaticamente se o produto ainda tiver algum estoque
                                const itemIndex = cart.findIndex(item => item.name === error.product);
                                if (itemIndex >= 0 && error.available > 0) {
                                    cart[itemIndex].quantity = error.available;
                                }
                            });
                            
                            errorHtml += '</ul><div class="mt-3">O carrinho foi atualizado automaticamente com as quantidades dispon√≠veis.</div>';
                            
                            // Renderizar o carrinho atualizado
            renderCartItems();
            updateTotals();
                            
                            // Mostrar mensagem ao usu√°rio
                            Swal.fire({
                                icon: 'warning',
                                title: 'Estoque Atualizado',
                                html: errorHtml,
                                confirmButtonText: 'OK'
                            });
                        } else {
                            // Outro erro n√£o relacionado a estoque
                            Swal.fire({
                                icon: 'error',
                                title: 'Erro na Venda',
                                text: errorMessage,
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(() => {
                        // Falha ao verificar estoque, mostrar mensagem gen√©rica
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro na Venda',
                            text: errorMessage,
                            confirmButtonText: 'OK'
                        });
                    });
            } else {
                // Outro tipo de erro
                Swal.fire({
                    icon: 'error',
                    title: 'Erro na Venda',
                    text: errorMessage,
                    confirmButtonText: 'OK'
                });
            }
            
            // Restaurar o bot√£o
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check-circle me-1"></i> Confirmar Venda';
        });
    });

    // Configurar o desconto para atualizar totais
    document.getElementById('desconto').addEventListener('input', updateTotals);

    // Configurar o manipulador para Enter no modal de confirma√ß√£o
    document.getElementById('confirmationModal').addEventListener('shown.bs.modal', function() {
        // Desativar temporariamente o event listener global de atalhos
        document.removeEventListener('keydown', handleShortcutKeys);
        
        // Criar uma fun√ß√£o global para lidar com o Enter
        window.handleConfirmEnter = function(event) {
            if (event.key === 'Enter' && !event.repeat) {
                event.preventDefault();
                event.stopPropagation();
                const confirmButton = document.getElementById('confirm-sale');
                if (!confirmButton.disabled) {
                    confirmButton.click();
                }
                return false;
            }
        };
        
        // Adicionar o event listener global
        document.addEventListener('keydown', window.handleConfirmEnter);
    });
    
    document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', function() {
        // Remover o event listener espec√≠fico do modal
        if (window.handleConfirmEnter) {
            document.removeEventListener('keydown', window.handleConfirmEnter);
        }
        // Reativar o event listener global de atalhos
        document.addEventListener('keydown', handleShortcutKeys);
    });

    // Quando o processamento da venda for conclu√≠do com sucesso e mostrarmos o bot√£o de fechar
    // Adicionar um event listener para permitir o fechamento com Enter
    function activateSuccessCloseWithEnter() {
        window.handleSuccessEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.stopPropagation();
                // Clicar no bot√£o de ver hist√≥rico (fechar)
                document.getElementById('view-sales-history').click();
                return false;
            }
        };
        
        // Adicionar o event listener global
        document.addEventListener('keydown', window.handleSuccessEnter);
    }

    // Fun√ß√£o para resetar o PDV
    function resetPDV() {
        // Limpar o carrinho
        cart = [];
            renderCartItems();
            updateTotals();

        // Resetar campos de entrada
        document.getElementById('codigo_produto').value = '';
        document.getElementById('desconto').value = '0';
        document.getElementById('metodo_pagamento').selectedIndex = 0;
        document.getElementById('customer-search').value = '';
        document.getElementById('customer-id').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('payment-amount').value = '';

        // Remover classe de valida√ß√£o do campo de cliente
        document.getElementById('customer-search').classList.remove('is-valid');

        // Esconder elementos relacionados ao troco
        document.getElementById('change-container').style.display = 'none';
        document.getElementById('change-amount').textContent = 'R$ 0,00';

        // Remover listeners espec√≠ficos dos modais
        if (window.handleConfirmEnter) {
            document.removeEventListener('keydown', window.handleConfirmEnter);
            window.handleConfirmEnter = null;
        }
        if (window.handleSuccessEnter) {
            document.removeEventListener('keydown', window.handleSuccessEnter);
            window.handleSuccessEnter = null;
        }

        // Esconder bot√£o de limpar cliente
        const clearButton = document.querySelector('.position-relative button');
        if (clearButton) {
            clearButton.style.display = 'none';
        }

        // Resetar estado do bot√£o finalizar venda
        const finishSaleBtn = document.getElementById('btn-finalizar');
        if (finishSaleBtn) {
            finishSaleBtn.disabled = false;
            finishSaleBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Finalizar Venda';
        }

        // Resetar estado do bot√£o confirmar venda no modal
        const confirmSaleBtn = document.getElementById('confirm-sale');
        if (confirmSaleBtn) {
            confirmSaleBtn.disabled = false;
            confirmSaleBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Confirmar Venda';
        }
        
        // Reativar manipuladores de atalhos globais
        document.removeEventListener('keydown', handleShortcutKeys);
        document.addEventListener('keydown', handleShortcutKeys);
    }

    // Adicionar estilos CSS para anima√ß√£o de destaque
    document.addEventListener('DOMContentLoaded', function() {
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            @keyframes highlightItem {
                0% { background-color: rgba(25, 135, 84, 0.3); }
                100% { background-color: white; }
            }
            
            .highlight-animation {
                animation: highlightItem 1.5s ease-out;
            }
        `;
        document.head.appendChild(styleElement);
    });

    // Fun√ß√£o para dar destaque a um item do carrinho
    function highlightCartItem(productId) {
        setTimeout(() => {
            const item = document.getElementById(`cart-item-${productId}`);
            if (item) {
                item.classList.add('highlight-animation');
                // Remover classe ap√≥s a anima√ß√£o para permitir repeti√ß√µes
                setTimeout(() => {
                    item.classList.remove('highlight-animation');
                }, 1500);
            }
        }, 100); // Pequeno atraso para garantir que o item j√° est√° renderizado
    }

    // Configurar o bot√£o de adicionar ao carrinho
    document.getElementById('add-to-cart').addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const name = this.getAttribute('data-name');
        const price = parseFloat(this.getAttribute('data-price'));
        const code = this.getAttribute('data-code');
        const quantity = parseInt(document.getElementById('product-quantity').value) || 1;
        
        // Validar quantidade
        if (quantity < 1) {
            Swal.fire({
                icon: 'warning',
                title: 'Quantidade Inv√°lida',
                text: 'A quantidade deve ser no m√≠nimo 1.',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Verificar quantidade atual no carrinho
        const quantityInCart = getProductQuantityInCart(id);
        const totalQuantity = quantityInCart + quantity;
        
        // Verificar estoque no back-end antes de adicionar ao carrinho
        fetch("{% url 'sales:check_stock' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                product_id: id,
                quantity: totalQuantity  // Considerar o que j√° est√° no carrinho
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Estoque dispon√≠vel, adicionar ao carrinho
                const productIndex = findProductInCart(id);
                
                if (productIndex >= 0) {
                    // Produto j√° existe no carrinho, atualizar quantidade
                    cart[productIndex].quantity = totalQuantity;
                    
                    // Mostrar mensagem de atualiza√ß√£o
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true
                    });
                    
                    Toast.fire({
                        icon: 'success',
                        title: `Produto atualizado (${totalQuantity}x)`
                    });
                } else {
                    // Produto n√£o existe no carrinho, adicionar novo item
                    cart.push({
                        id: id,
                        name: name,
                        price: price,
                        quantity: quantity,
                        code: code
                    });
                    
                    // Mostrar mensagem de adi√ß√£o
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true
                    });
                    
                    Toast.fire({
                        icon: 'success',
                        title: 'Produto adicionado ao carrinho'
                    });
                }
                
                // Atualizar interface
                renderCartItems();
                updateTotals();
                
                // Destacar o item adicionado/atualizado
                highlightCartItem(id);
                
                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('modalQuantidade')).hide();
                
                // Remover backdrops para evitar escurecimento progressivo
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    backdrop.remove();
                });
                
                // Limpar sele√ß√µes e reexibir todos os produtos
                const productsTable = document.getElementById('products-grid');
                const allRows = productsTable.querySelectorAll('tbody tr.product-item');
                allRows.forEach(row => {
                    row.classList.remove('selected');
                    row.classList.remove('not-selected');
                    row.style.outline = '';
                    row.style.display = '';
                });
                
                // Limpar e focar no campo de busca
                const searchInput = document.getElementById('codigo_produto');
                searchInput.value = '';
                searchInput.focus();
                } else {
                // Estoque insuficiente, mostrar mensagem de erro
                let availableForNew = data.available - quantityInCart;
                let errorMessage = data.error;
                
                // Se j√° tem no carrinho, mostrar informa√ß√£o mais detalhada
                if (quantityInCart > 0) {
                    errorMessage = `Estoque insuficiente. Voc√™ j√° tem ${quantityInCart} unidades deste produto no carrinho e est√° tentando adicionar mais ${quantity}.
                    Estoque dispon√≠vel: ${data.available}. Voc√™ pode adicionar no m√°ximo mais ${Math.max(0, availableForNew)} unidades.`;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Estoque Insuficiente',
                    text: errorMessage,
                    confirmButtonText: 'OK'
                });
                
                // Atualizar a informa√ß√£o de estoque no modal
                if (data.available !== undefined) {
                    document.getElementById('modal-product-stock').textContent = data.available;
                }
            }
        })
        .catch(error => {
            console.error('Erro ao verificar estoque:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Ocorreu um erro ao verificar o estoque. Tente novamente.',
                confirmButtonText: 'OK'
            });
        });
    });

    // Configurar a captura da tecla Enter no modal de quantidade
    document.getElementById('modalQuantidade').addEventListener('shown.bs.modal', function() {
        const quantityInput = document.getElementById('product-quantity');
        quantityInput.focus();
        quantityInput.select();
        
        // Desabilitar temporariamente os atalhos globais
        document.removeEventListener('keydown', handleShortcutKeys);
        
        // Configurar os bot√µes + e - para aumentar/diminuir quantidade
        document.getElementById('increase-qty').onclick = function() {
            let currentValue = parseInt(quantityInput.value) || 0;
            quantityInput.value = currentValue + 1;
        };
        
        document.getElementById('decrease-qty').onclick = function() {
            let currentValue = parseInt(quantityInput.value) || 0;
            quantityInput.value = Math.max(1, currentValue - 1);
        };
        
        // Permitir usar setas para aumentar/diminuir quantidade
        quantityInput.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                let value = parseInt(this.value) || 0;
                this.value = value + 1;
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                let value = parseInt(this.value) || 0;
                this.value = Math.max(1, value - 1);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                // Confirmar a sele√ß√£o quando pressionar Enter
                document.getElementById('add-to-cart').click();
            }
        });
    });
    
    document.getElementById('modalQuantidade').addEventListener('hidden.bs.modal', function() {
        // Reativar atalhos globais quando o modal √© fechado
        document.addEventListener('keydown', handleShortcutKeys);
        
        // Remover backdrops para evitar escurecimento progressivo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
    });

    // Ativar os atalhos de teclado (F1, F2, F3, F4) - Adicionado novamente aqui no final para garantir funcionamento
    document.addEventListener('keydown', handleShortcutKeys);
    console.log("Atalhos de teclado ativados! F1=Busca, F2=Pagamento, F3=Desconto, F4=Finalizar");

    // Fun√ß√µes para abrir os modais espec√≠ficos requeridos pelos atalhos F1-F4
    function abrirModalBuscaProduto() {
        // Abrir o modal de busca de produtos
        const modalBusca = new bootstrap.Modal(document.getElementById('modalBuscaProduto'));
        modalBusca.show();
        
        // Focar no campo de busca
        setTimeout(() => {
            const searchInput = document.getElementById('modal-product-search');
            searchInput.value = '';
            searchInput.focus();
        }, 300);
    }

    function abrirModalFormaPagamento() {
        // Abrir o modal de pagamento
        const modalPagamento = new bootstrap.Modal(document.getElementById('modalFormaPagamento'));
        modalPagamento.show();
        
        // Preparar os dados do modal
        document.getElementById('modal-payment-method').selectedIndex = 0;
        document.getElementById('modal-change-container').style.display = 'none';
        
        // Focar no m√©todo de pagamento
        setTimeout(() => {
            document.getElementById('modal-payment-method').focus();
        }, 300);
    }

    function abrirModalDesconto() {
        // Obter o valor atual de subtotal e desconto
        const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('R$ ', '').replace('.', '').replace(',', '.'));
        const currentDiscount = parseFloat(document.getElementById('desconto').value || 0);
        
        // Abrir o modal de desconto
        const modalDesconto = new bootstrap.Modal(document.getElementById('modalDesconto'));
        modalDesconto.show();
        
        // Preparar os dados do modal
        document.getElementById('modal-discount').value = currentDiscount;
        document.getElementById('modal-subtotal').textContent = `R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('modal-discount-display').textContent = `R$ ${currentDiscount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('modal-total-after-discount').textContent = `R$ ${(subtotal - currentDiscount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
        // Focar no campo de desconto
        setTimeout(() => {
            const discountInput = document.getElementById('modal-discount');
            discountInput.focus();
            discountInput.select();
        }, 300);
    }

    function finalizarVenda() {
        if (cart.length > 0) {
            document.getElementById('btn-finalizar').click();
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Carrinho Vazio',
                text: 'Adicione produtos ao carrinho antes de finalizar a venda.',
                confirmButtonText: 'OK'
            });
        }
    }

    // Substituir o handleShortcutKeys para usar as novas fun√ß√µes
    function handleShortcutKeys(e) {
        // Evitar atalhos se algum modal estiver aberto
        if (document.querySelector('.modal.show')) {
            return;
        }
        
        // F1 - Focar no campo de busca de produtos
        if (e.key === 'F1') {
            e.preventDefault();
            document.getElementById('codigo_produto').focus();
            document.getElementById('codigo_produto').select();
            return false;
        }
        
        // F2 - Abrir o modal de m√©todo de pagamento
        else if (e.key === 'F2') {
            e.preventDefault();
            abrirModalFormaPagamento();
            return false;
        }
        
        // F3 - Abrir modal de desconto
        else if (e.key === 'F3') {
            e.preventDefault();
            abrirModalDesconto();
            return false;
        }
        
        // F4 - Finalizar a venda
        else if (e.key === 'F4') {
            e.preventDefault();
            finalizarVenda();
            return false;
        }
    }

    // Registrar novamente o event listener com a nova fun√ß√£o
    document.removeEventListener('keydown', handleShortcutKeys);
    
    // REMOVIDO: Substitu√≠do pelo c√≥digo em pdv.js
    /*
    // Implementar uma vers√£o mais robusta do handler de teclas
    window.addEventListener("keydown", function(event) {
        // ... c√≥digo existente removido ...
    }, true);
    */
    
    console.log("Atalhos de teclado atualizados para usar pdv.js!");

    // Configurar o bot√£o de confirmar desconto
    document.addEventListener('DOMContentLoaded', function() {
        const confirmDiscountBtn = document.getElementById('confirm-discount');
        if (confirmDiscountBtn) {
            confirmDiscountBtn.addEventListener('click', function() {
                // Obter valor de desconto do modal
                const discountValue = parseFloat(document.getElementById('modal-discount').value) || 0;
                
                // Aplicar o desconto no campo principal
                document.getElementById('desconto').value = discountValue;
                
                // Atualizar totais
                updateTotals();
                
                // Fechar o modal
                bootstrap.Modal.getInstance(document.getElementById('modalDesconto')).hide();
                
                // Toast de confirma√ß√£o
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true
                });
                
                Toast.fire({
                    icon: 'success',
                    title: `Desconto de R$ ${discountValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})} aplicado`
                });
            });
        }
        
        // Atualizar display do desconto no modal quando o valor mudar
        const modalDiscount = document.getElementById('modal-discount');
        if (modalDiscount) {
            modalDiscount.addEventListener('input', function() {
                const subtotalText = document.getElementById('modal-subtotal').textContent;
                const subtotal = parseFloat(subtotalText.replace('R$ ', '').replace('.', '').replace(',', '.')) || 0;
                const discount = parseFloat(this.value) || 0;
                
                document.getElementById('modal-discount-display').textContent = `R$ ${discount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('modal-total-after-discount').textContent = `R$ ${(subtotal - discount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            });
        }
        
        // Adicionar evento de clique direto nos produtos para garantir funcionamento
        const productItems = document.querySelectorAll('#products-grid tbody tr.product-item');
        if (productItems.length > 0) {
            productItems.forEach(item => {
                item.addEventListener('click', function() {
                    // N√£o selecionar produtos sem estoque
                    if (this.classList.contains('out-of-stock')) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Produto Indispon√≠vel',
                            text: 'Este produto est√° sem estoque.',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
                    
                    // Limpar sele√ß√µes anteriores
                    document.querySelectorAll('#products-grid tbody tr.product-item').forEach(row => {
                        row.classList.remove('selected');
                        row.classList.remove('not-selected');
                        row.style.outline = '';
                    });
                    
                    // Selecionar o produto clicado
                    this.classList.add('selected');
                    this.style.outline = '2px solid #198754';
                    
                    // Selecionar o produto
                    selectProduct(this);
                });
            });
        }
    });

    // Configurar evento para o modal de m√©todo de pagamento
    document.getElementById('modal-payment-method').addEventListener('change', function() {
        const paymentMethod = this.options[this.selectedIndex].textContent.trim();
        const changeContainer = document.getElementById('modal-change-container');
        
        if (paymentMethod.includes('Dinheiro')) {
            changeContainer.style.display = 'block';
            document.getElementById('modal-payment-amount').focus();
        } else {
            changeContainer.style.display = 'none';
        }
    });
    
    // C√°lculo de troco no modal
    document.getElementById('modal-payment-amount').addEventListener('input', function() {
        const totalText = document.getElementById('total').textContent.trim();
        const total = parseFloat(totalText.replace('R$', '').replace('.', '').replace(',', '.')) || 0;
        const paymentAmount = parseFloat(this.value) || 0;
        const changeAmount = Math.max(0, paymentAmount - total);
        
        document.getElementById('modal-change-amount').textContent = `R$ ${changeAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    });
    
    // Configurar bot√£o de confirmar m√©todo de pagamento
    document.getElementById('confirm-payment-method').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalFormaPagamento'));
        const selectedOption = document.getElementById('modal-payment-method').selectedOptions[0];
        
        if (!selectedOption || selectedOption.value === '') {
            Swal.fire({
                icon: 'warning',
                title: 'M√©todo de Pagamento',
                text: 'Selecione um m√©todo de pagamento v√°lido.',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Transferir dados para a interface principal
        const mainPaymentSelect = document.getElementById('metodo_pagamento');
        for (let i = 0; i < mainPaymentSelect.options.length; i++) {
            if (mainPaymentSelect.options[i].value === selectedOption.value) {
                mainPaymentSelect.selectedIndex = i;
                break;
            }
        }
        
        // Se for dinheiro, transferir valor e calcular troco
        if (selectedOption.textContent.includes('Dinheiro')) {
            const paymentAmount = parseFloat(document.getElementById('modal-payment-amount').value) || 0;
            document.getElementById('payment-amount').value = paymentAmount;
            
            // Calcular troco
            const totalText = document.getElementById('total').textContent.trim();
            const total = parseFloat(totalText.replace('R$', '').replace('.', '').replace(',', '.')) || 0;
            const changeAmount = Math.max(0, paymentAmount - total);
            
            document.getElementById('change-amount').textContent = `R$ ${changeAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('change-container').style.display = 'block';
        } else {
            document.getElementById('change-container').style.display = 'none';
        }
        
        // Fechar modal
        modal.hide();
        
        // Toast de confirma√ß√£o
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 1500,
            timerProgressBar: true
        });
        
        Toast.fire({
            icon: 'success',
            title: `M√©todo de pagamento: ${selectedOption.textContent.trim()}`
        });
    });
    
    // Adicionar tecla Enter no modal de m√©todo de pagamento
    document.getElementById('modalFormaPagamento').addEventListener('shown.bs.modal', function() {
        const paymentMethodSelect = document.getElementById('modal-payment-method');
        paymentMethodSelect.focus();
        
        // Evento para a tecla Enter
        const handlePaymentEnter = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // Se estiver no campo de valor pago, clicar no bot√£o confirmar
                if (document.activeElement === document.getElementById('modal-payment-amount')) {
                    document.getElementById('confirm-payment-method').click();
                } 
                // Se estiver no select, verificar se √© dinheiro para focar no campo de valor
                else if (document.activeElement === paymentMethodSelect) {
                    const selected = paymentMethodSelect.options[paymentMethodSelect.selectedIndex];
                    if (selected && selected.textContent.includes('Dinheiro')) {
                        document.getElementById('modal-payment-amount').focus();
                    } else {
                        document.getElementById('confirm-payment-method').click();
                    }
                }
            }
        };
        
        document.addEventListener('keydown', handlePaymentEnter);
        
        // Remover o listener quando o modal for fechado
        this.addEventListener('hidden.bs.modal', function() {
            document.removeEventListener('keydown', handlePaymentEnter);
        });
    });
    
    // Adicionar tecla Enter no modal de desconto
    document.getElementById('modalDesconto').addEventListener('shown.bs.modal', function() {
        const discountInput = document.getElementById('modal-discount');
        discountInput.focus();
        discountInput.select();
        
        // Evento para a tecla Enter
        const handleDiscountEnter = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('confirm-discount').click();
            }
        };
        
        document.addEventListener('keydown', handleDiscountEnter);
        
        // Remover o listener quando o modal for fechado
        this.addEventListener('hidden.bs.modal', function() {
            document.removeEventListener('keydown', handleDiscountEnter);
        });
    });
</script>
</div>
<!-- Incluir o script pdv.js -->
<script src="{% static 'js/pdv.js' %}"></script>
{% endblock %} 