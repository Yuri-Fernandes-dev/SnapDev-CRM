{% extends 'core/base.html' %}

{% block title %}PDV - SaaS CRM{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        cursor: pointer;
        transition: all 0.2s;
    }
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .cart-item {
        border-bottom: 1px solid #e9ecef;
        padding: 0.75rem 0;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    #product-container {
        height: calc(100vh - 300px);
        overflow-y: auto;
    }
    #cart-container {
        height: calc(100vh - 380px);
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">Ponto de Venda (PDV)</h1>
    <a href="{% url 'sale_list' %}" class="btn btn-outline-primary">
        <i class="fas fa-list me-1"></i> Histórico de Vendas
    </a>
</div>

<div class="row g-4">
    <!-- Produtos -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="product-search" class="form-control" placeholder="Buscar produto...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="category-filter" class="form-select">
                            <option value="">Todas as categorias</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="barcode-scan" class="btn btn-primary w-100">
                            <i class="fas fa-barcode"></i> Scan
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="product-container" class="p-3">
                    <div class="row g-3" id="products-grid">
                        {% for product in products %}
                        <div class="col-md-3 col-sm-6 product-item" 
                            data-id="{{ product.id }}" 
                            data-name="{{ product.name }}" 
                            data-price="{{ product.price }}" 
                            data-stock="{{ product.stock_quantity }}"
                            data-code="{{ product.code }}"
                            data-barcode="{{ product.barcode }}"
                            data-category="{{ product.category.name }}">
                            <div class="card product-card h-100 border-0 shadow-sm">
                                <div class="card-body p-3 text-center">
                                    <div class="mb-2">
                                        <span class="badge bg-primary">R$ {{ product.price }}</span>
                                        {% if product.stock_quantity <= product.stock_alert_level %}
                                        <span class="badge bg-danger">Estoque: {{ product.stock_quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <h6 class="card-title mb-0">{{ product.name }}</h6>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <p class="mb-0 text-muted">Nenhum produto encontrado. <a href="{% url 'product_create' %}">Cadastre um produto</a>.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Carrinho -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <h5 class="mb-0">Carrinho</h5>
            </div>
            <div class="card-body p-0">
                <div id="cart-container" class="p-3">
                    <div id="cart-items">
                        <!-- Itens do carrinho serão adicionados aqui -->
                        <div class="text-center text-muted py-5" id="empty-cart-message">
                            <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                            <p class="mb-0">Adicione produtos ao carrinho</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-bold" id="subtotal">R$ 0,00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Desconto:</span>
                        <div class="input-group" style="width: 150px;">
                            <input type="number" id="discount" class="form-control" value="0" min="0" step="0.01">
                            <span class="input-group-text">R$</span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-5">Total:</span>
                        <span class="fs-5 fw-bold" id="total">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <div class="mb-3">
                        <label for="payment-method" class="form-label">Método de Pagamento</label>
                        <select id="payment-method" class="form-select">
                            {% for method in payment_methods %}
                            <option value="{{ method.id }}">{{ method.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="customer" class="form-label">Cliente (opcional)</label>
                        <select id="customer" class="form-select">
                            <option value="">Selecione um cliente</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Observações</label>
                        <textarea id="notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <button id="finalize-sale" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-check-circle me-1"></i> Finalizar Venda
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Quantidade -->
<div class="modal fade" id="quantityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-product-name">Nome do Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Preço: <span class="fw-bold" id="modal-product-price">R$ 0,00</span></p>
                <p class="mb-3">Estoque disponível: <span class="fw-bold" id="modal-product-stock">0</span></p>
                
                <div class="mb-3">
                    <label for="product-quantity" class="form-label">Quantidade</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" id="decrease-qty">-</button>
                        <input type="number" id="product-quantity" class="form-control text-center" value="1" min="1">
                        <button class="btn btn-outline-secondary" type="button" id="increase-qty">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="add-to-cart">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Total a pagar: <span class="fw-bold" id="confirm-total">R$ 0,00</span></p>
                <p>Método de pagamento: <span id="confirm-payment-method">Dinheiro</span></p>
                <p id="confirm-customer-container">Cliente: <span id="confirm-customer">-</span></p>
                
                <div class="alert alert-success mt-3" id="sale-success-message" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i> Venda realizada com sucesso!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirm-sale">Confirmar Venda</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos
        const productsGrid = document.getElementById('products-grid');
        const productSearch = document.getElementById('product-search');
        const categoryFilter = document.getElementById('category-filter');
        const cartItems = document.getElementById('cart-items');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const totalEl = document.getElementById('total');
        const paymentMethodEl = document.getElementById('payment-method');
        const customerEl = document.getElementById('customer');
        const notesEl = document.getElementById('notes');
        const finalizeSaleBtn = document.getElementById('finalize-sale');
        
        // Modal de quantidade
        const quantityModal = new bootstrap.Modal(document.getElementById('quantityModal'));
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductPrice = document.getElementById('modal-product-price');
        const modalProductStock = document.getElementById('modal-product-stock');
        const productQuantity = document.getElementById('product-quantity');
        const decreaseQtyBtn = document.getElementById('decrease-qty');
        const increaseQtyBtn = document.getElementById('increase-qty');
        const addToCartBtn = document.getElementById('add-to-cart');
        
        // Modal de confirmação
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        const confirmTotal = document.getElementById('confirm-total');
        const confirmPaymentMethod = document.getElementById('confirm-payment-method');
        const confirmCustomerContainer = document.getElementById('confirm-customer-container');
        const confirmCustomer = document.getElementById('confirm-customer');
        const confirmSaleBtn = document.getElementById('confirm-sale');
        const saleSuccessMessage = document.getElementById('sale-success-message');
        
        // Estado do carrinho
        let cart = [];
        let currentProduct = null;
        
        // Evento de clique nos produtos
        productsGrid.addEventListener('click', function(e) {
            const productCard = e.target.closest('.product-item');
            if (!productCard) return;
            
            currentProduct = {
                id: productCard.dataset.id,
                name: productCard.dataset.name,
                price: parseFloat(productCard.dataset.price),
                stock: parseInt(productCard.dataset.stock, 10)
            };
            
            modalProductName.textContent = currentProduct.name;
            modalProductPrice.textContent = `R$ ${currentProduct.price.toFixed(2)}`;
            modalProductStock.textContent = currentProduct.stock;
            productQuantity.value = 1;
            productQuantity.max = currentProduct.stock;
            
            quantityModal.show();
        });
        
        // Controles de quantidade
        decreaseQtyBtn.addEventListener('click', function() {
            if (productQuantity.value > 1) {
                productQuantity.value = parseInt(productQuantity.value, 10) - 1;
            }
        });
        
        increaseQtyBtn.addEventListener('click', function() {
            if (parseInt(productQuantity.value, 10) < currentProduct.stock) {
                productQuantity.value = parseInt(productQuantity.value, 10) + 1;
            }
        });
        
        // Adicionar ao carrinho
        addToCartBtn.addEventListener('click', function() {
            const quantity = parseInt(productQuantity.value, 10);
            
            if (quantity > 0 && quantity <= currentProduct.stock) {
                const existingItem = cart.find(item => item.id === currentProduct.id);
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.subtotal = existingItem.quantity * existingItem.price;
                } else {
                    cart.push({
                        id: currentProduct.id,
                        name: currentProduct.name,
                        price: currentProduct.price,
                        quantity: quantity,
                        subtotal: currentProduct.price * quantity
                    });
                }
                
                updateCartDisplay();
                quantityModal.hide();
            }
        });
        
        // Atualizar display do carrinho
        function updateCartDisplay() {
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center text-muted py-5" id="empty-cart-message">
                        <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                        <p class="mb-0">Adicione produtos ao carrinho</p>
                    </div>
                `;
            } else {
                emptyCartMessage.style.display = 'none';
                
                let cartHTML = '';
                cart.forEach((item, index) => {
                    cartHTML += `
                        <div class="cart-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">${item.name}</h6>
                                <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">${item.quantity} x R$ ${item.price.toFixed(2)}</small>
                                </div>
                                <span>R$ ${item.subtotal.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = cartHTML;
                
                // Eventos para remover itens
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index, 10);
                        cart.splice(index, 1);
                        updateCartDisplay();
                        updateTotals();
                    });
                });
            }
            
            updateTotals();
        }
        
        // Atualizar totais
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
            const discount = parseFloat(discountEl.value) || 0;
            const total = Math.max(subtotal - discount, 0);
            
            subtotalEl.textContent = `R$ ${subtotal.toFixed(2)}`;
            totalEl.textContent = `R$ ${total.toFixed(2)}`;
        }
        
        // Evento de mudança no desconto
        discountEl.addEventListener('input', updateTotals);
        
        // Finalizar venda
        finalizeSaleBtn.addEventListener('click', function() {
            if (cart.length === 0) {
                alert('Adicione produtos ao carrinho antes de finalizar a venda.');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + item.subtotal, 0) - (parseFloat(discountEl.value) || 0);
            const paymentMethodText = paymentMethodEl.options[paymentMethodEl.selectedIndex].text;
            const customerText = customerEl.selectedIndex > 0 ? customerEl.options[customerEl.selectedIndex].text : '-';
            
            confirmTotal.textContent = `R$ ${total.toFixed(2)}`;
            confirmPaymentMethod.textContent = paymentMethodText;
            confirmCustomer.textContent = customerText;
            confirmCustomerContainer.style.display = customerEl.value ? 'block' : 'none';
            
            confirmationModal.show();
        });
        
        // Confirmar venda
        confirmSaleBtn.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processando...';
            
            const saleData = {
                customer_id: customerEl.value || null,
                payment_method_id: paymentMethodEl.value,
                items: cart.map(item => ({
                    product_id: item.id,
                    quantity: item.quantity,
                    price: item.price
                })),
                discount: parseFloat(discountEl.value) || 0,
                notes: notesEl.value
            };
            
            // Enviar venda para o servidor
            fetch('{% url "create_sale" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(saleData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    saleSuccessMessage.style.display = 'block';
                    confirmSaleBtn.style.display = 'none';
                    document.querySelector('.btn-secondary').textContent = 'Fechar';
                    
                    // Limpar carrinho
                    cart = [];
                    updateCartDisplay();
                    
                    // Redirecionar após 2 segundos
                    setTimeout(() => {
                        window.location.href = `{% url 'sale_detail' 1 %}`.replace('1', data.sale_id);
                    }, 2000);
                } else {
                    alert('Erro ao processar a venda. Tente novamente.');
                    confirmSaleBtn.disabled = false;
                    confirmSaleBtn.innerHTML = 'Confirmar Venda';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao processar a venda. Tente novamente.');
                confirmSaleBtn.disabled = false;
                confirmSaleBtn.innerHTML = 'Confirmar Venda';
            });
        });
        
        // Busca de produtos
        productSearch.addEventListener('input', filterProducts);
        categoryFilter.addEventListener('change', filterProducts);
        
        function filterProducts() {
            const searchTerm = productSearch.value.toLowerCase();
            const categoryTerm = categoryFilter.value.toLowerCase();
            
            document.querySelectorAll('.product-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const code = (item.dataset.code || '').toLowerCase();
                const barcode = (item.dataset.barcode || '').toLowerCase();
                const categoryMatch = !categoryTerm || item.dataset.category === categoryTerm;
                const searchMatch = !searchTerm || 
                    name.includes(searchTerm) || 
                    code.includes(searchTerm) || 
                    barcode.includes(searchTerm);
                
                item.style.display = (categoryMatch && searchMatch) ? 'block' : 'none';
            });
        }
    });
</script>
{% endblock %} 