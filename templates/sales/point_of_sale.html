{% extends 'core/base.html' %}

{% block title %}PDV - SaaS CRM{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        cursor: pointer;
        transition: all 0.2s;
    }
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .cart-item {
        border-bottom: 1px solid #e9ecef;
        padding: 0.75rem 0;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    #product-container {
        height: calc(100vh - 300px);
        overflow-y: auto;
    }
    #cart-container {
        height: calc(100vh - 650px);
        overflow-y: auto;
    }
    .customer-suggestion {
        cursor: pointer;
        padding: 5px 10px;
    }
    .customer-suggestion:hover {
        background-color: #f8f9fa;
    }
    .total-value {
        font-size: 1.5rem;
        color: #198754;
        font-weight: bold;
    }
    .change-value {
        font-size: 1.25rem;
        color: #0d6efd;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                Venda realizada com sucesso!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">Ponto de Venda (PDV)</h1>
    <a href="{% url 'sale_list' %}" class="btn btn-outline-primary">
        <i class="fas fa-list me-1"></i> Histórico de Vendas
    </a>
</div>

<div class="row g-4">
    <!-- Produtos -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="product-search" class="form-control" placeholder="Digite o código do produto...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="category-filter" class="form-select">
                            <option value="">Todas as categorias</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="barcode-scan" class="btn btn-primary w-100">
                            <i class="fas fa-barcode"></i> Scan
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="product-container" class="p-3">
                    <div class="row g-3" id="products-grid">
                        {% for product in products %}
                        <div class="col-md-3 col-sm-6 product-item" 
                            data-id="{{ product.id }}" 
                            data-name="{{ product.name }}" 
                            data-price="{{ product.price }}" 
                            data-stock="{{ product.stock_quantity }}"
                            data-code="{{ product.code }}"
                            data-barcode="{{ product.barcode }}"
                            data-category="{{ product.category.name }}">
                            <div class="card product-card h-100 border-0 shadow-sm">
                                <div class="card-body p-3 text-center">
                                    <div class="mb-2">
                                        <span class="badge bg-primary">R$ {{ product.price }}</span>
                                        {% if product.stock_quantity <= product.stock_alert_level %}
                                        <span class="badge bg-danger">Estoque: {{ product.stock_quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <h6 class="card-title mb-0">{{ product.name }}</h6>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <p class="mb-0 text-muted">Nenhum produto encontrado. <a href="{% url 'product_create' %}">Cadastre um produto</a>.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Carrinho -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 py-3">
                <h5 class="mb-0">Carrinho</h5>
            </div>
            <div class="card-body p-0">
                <div id="cart-container" class="p-3">
                    <div id="cart-items">
                        <!-- Itens do carrinho serão adicionados aqui -->
                        <div class="text-center text-muted py-5" id="empty-cart-message">
                            <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                            <p class="mb-0">Adicione produtos ao carrinho</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-bold" id="subtotal">R$ 0,00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Desconto:</span>
                        <div class="input-group" style="width: 150px;">
                            <input type="number" id="discount" class="form-control" value="0" min="0" step="0.01">
                            <span class="input-group-text">R$</span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-5">Total:</span>
                        <span class="total-value" id="total">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <div class="mb-3">
                        <label for="payment-method" class="form-label">Método de Pagamento</label>
                        <select id="payment-method" class="form-select">
                            <option value="">Selecione o método de pagamento</option>
                            {% for method in payment_methods %}
                            <option value="{{ method.id }}">{{ method.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="change-container" style="display: none;" class="mb-3">
                        <label for="payment-amount" class="form-label">Valor Pago</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="number" id="payment-amount" class="form-control" step="0.01" min="0">
                        </div>
                        <div class="mt-2">
                            <span class="fs-5">Troco: </span>
                            <span class="change-value" id="change-amount">R$ 0,00</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="customer-search" class="form-label">Cliente (opcional)</label>
                        <div class="position-relative">
                            <input type="text" id="customer-search" class="form-control" placeholder="Digite o nome do cliente...">
                            <input type="hidden" id="customer-id">
                            <div id="customer-suggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Observações</label>
                        <textarea id="notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <button id="finalize-sale" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-check-circle me-1"></i> Finalizar Venda
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Quantidade -->
<div class="modal fade" id="quantityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-product-name">Nome do Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Preço: <span class="fw-bold" id="modal-product-price">R$ 0,00</span></p>
                <p class="mb-3">Estoque disponível: <span class="fw-bold" id="modal-product-stock">0</span></p>
                
                <div class="mb-3">
                    <label for="product-quantity" class="form-label">Quantidade</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" id="decrease-qty">-</button>
                        <input type="number" id="product-quantity" class="form-control text-center" value="1" min="1">
                        <button class="btn btn-outline-secondary" type="button" id="increase-qty">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="add-to-cart">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Total a pagar: <span class="fw-bold" id="confirm-total">R$ 0,00</span></p>
                <p>Método de pagamento: <span id="confirm-payment-method">Dinheiro</span></p>
                <p id="confirm-customer-container">Cliente: <span id="confirm-customer">-</span></p>
                
                <div class="alert alert-success mt-3" id="sale-success-message" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i> Venda realizada com sucesso!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirm-sale">Confirmar Venda</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos
        const productsGrid = document.getElementById('products-grid');
        const productSearch = document.getElementById('product-search');
        const categoryFilter = document.getElementById('category-filter');
        const cartItems = document.getElementById('cart-items');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const subtotalEl = document.getElementById('subtotal');
        const discountEl = document.getElementById('discount');
        const totalEl = document.getElementById('total');
        const paymentMethodEl = document.getElementById('payment-method');
        const customerSearch = document.getElementById('customer-search');
        const customerId = document.getElementById('customer-id');
        const notesEl = document.getElementById('notes');
        const finalizeSaleBtn = document.getElementById('finalize-sale');
        const successToast = new bootstrap.Toast(document.getElementById('successToast'), {
            delay: 3000
        });
        
        // Modal de quantidade
        const quantityModal = new bootstrap.Modal(document.getElementById('quantityModal'));
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductPrice = document.getElementById('modal-product-price');
        const modalProductStock = document.getElementById('modal-product-stock');
        const productQuantity = document.getElementById('product-quantity');
        const decreaseQtyBtn = document.getElementById('decrease-qty');
        const increaseQtyBtn = document.getElementById('increase-qty');
        const addToCartBtn = document.getElementById('add-to-cart');
        
        // Modal de confirmação
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        const confirmTotal = document.getElementById('confirm-total');
        const confirmPaymentMethod = document.getElementById('confirm-payment-method');
        const confirmCustomerContainer = document.getElementById('confirm-customer-container');
        const confirmCustomer = document.getElementById('confirm-customer');
        const confirmSaleBtn = document.getElementById('confirm-sale');
        const saleSuccessMessage = document.getElementById('sale-success-message');
        
        // Estado do carrinho
        let cart = [];
        let currentProduct = null;
        
        // Adicionar evento de Enter no campo de quantidade
        document.getElementById('quantityModal').addEventListener('shown.bs.modal', function () {
            productQuantity.focus();
            productQuantity.select();
        });

        // Controles de quantidade
        productQuantity.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addToCartBtn.click();
            }
        });
        
        // Evento de clique nos produtos
        productsGrid.addEventListener('click', function(e) {
            const productCard = e.target.closest('.product-item');
            if (!productCard) return;
            
            showQuantityModal(productCard);
        });
        
        function showQuantityModal(productItem) {
            currentProduct = {
                id: productItem.dataset.id,
                name: productItem.dataset.name,
                price: parseFloat(productItem.dataset.price),
                stock: parseInt(productItem.dataset.stock, 10)
            };
            
            modalProductName.textContent = currentProduct.name;
            modalProductPrice.textContent = `R$ ${currentProduct.price.toFixed(2)}`;
            modalProductStock.textContent = currentProduct.stock;
            productQuantity.value = 1;
            productQuantity.max = currentProduct.stock;
            
            quantityModal.show();
        }
        
        // Adicionar ao carrinho
        addToCartBtn.addEventListener('click', function() {
            const quantity = parseInt(productQuantity.value, 10);
            
            if (quantity > 0 && quantity <= currentProduct.stock) {
                const existingItem = cart.find(item => item.id === currentProduct.id);
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.subtotal = existingItem.quantity * existingItem.price;
                } else {
                    cart.push({
                        id: currentProduct.id,
                        name: currentProduct.name,
                        price: currentProduct.price,
                        quantity: quantity,
                        subtotal: currentProduct.price * quantity
                    });
                }
                
                updateCartDisplay();
                quantityModal.hide();
                
                // Focar no campo de busca após adicionar ao carrinho
                productSearch.value = '';
                productSearch.focus();
            }
        });
        
        // Atualizar display do carrinho
        function updateCartDisplay() {
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center text-muted py-5" id="empty-cart-message">
                        <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                        <p class="mb-0">Adicione produtos ao carrinho</p>
                    </div>
                `;
            } else {
                emptyCartMessage.style.display = 'none';
                
                let cartHTML = '';
                cart.forEach((item, index) => {
                    cartHTML += `
                        <div class="cart-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">${item.name}</h6>
                                <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">${item.quantity} x R$ ${item.price.toFixed(2)}</small>
                                </div>
                                <span>R$ ${item.subtotal.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = cartHTML;
                
                // Eventos para remover itens
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index, 10);
                        cart.splice(index, 1);
                        updateCartDisplay();
                        updateTotals();
                    });
                });
            }
            
            updateTotals();
        }
        
        // Atualizar totais
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
            const discount = parseFloat(discountEl.value) || 0;
            const total = Math.max(subtotal - discount, 0);
            
            subtotalEl.textContent = `R$ ${subtotal.toFixed(2)}`;
            totalEl.textContent = `R$ ${total.toFixed(2)}`;
        }
        
        // Evento de mudança no desconto
        discountEl.addEventListener('input', updateTotals);
        
        // Atualizar o troco quando o valor pago é alterado
        const paymentAmount = document.getElementById('payment-amount');
        const changeAmount = document.getElementById('change-amount');
        paymentAmount.addEventListener('input', function() {
            const total = parseFloat(totalEl.textContent.replace('R$ ', '').replace(',', '.')) || 0;
            const paid = parseFloat(this.value) || 0;
            const change = paid - total;
            changeAmount.textContent = `R$ ${change.toFixed(2)}`.replace('.', ',');
        });

        // Atualizar campos quando método de pagamento é alterado
        paymentMethodEl.addEventListener('change', function() {
            const isDinheiro = this.options[this.selectedIndex].text.toLowerCase().includes('dinheiro');
            const changeContainer = document.getElementById('change-container');
            changeContainer.style.display = isDinheiro ? 'block' : 'none';
            
            if (isDinheiro) {
                const total = parseFloat(totalEl.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                paymentAmount.value = total.toFixed(2);
                const change = 0;
                changeAmount.textContent = `R$ ${change.toFixed(2)}`.replace('.', ',');
                paymentAmount.focus();
                paymentAmount.select();
            } else {
                paymentAmount.value = '';
                changeAmount.textContent = 'R$ 0,00';
            }
        });

        // Finalizar venda
        finalizeSaleBtn.addEventListener('click', function() {
            if (cart.length === 0) {
                alert('Adicione produtos ao carrinho antes de finalizar a venda.');
                return;
            }
            
            if (!paymentMethodEl.value) {
                alert('Selecione um método de pagamento antes de finalizar a venda.');
                paymentMethodEl.focus();
                return;
            }

            const isDinheiro = paymentMethodEl.options[paymentMethodEl.selectedIndex].text.toLowerCase().includes('dinheiro');
            if (isDinheiro) {
                const paid = parseFloat(paymentAmount.value) || 0;
                const total = parseFloat(totalEl.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                if (paid < total) {
                    alert('O valor pago deve ser maior ou igual ao total da venda.');
                    paymentAmount.focus();
                    return;
                }
            }
            
            const total = cart.reduce((sum, item) => sum + item.subtotal, 0) - (parseFloat(discountEl.value) || 0);
            const paymentMethodText = paymentMethodEl.options[paymentMethodEl.selectedIndex].text;
            const customerText = customerSearch.value || '-';
            
            confirmTotal.textContent = `R$ ${total.toFixed(2)}`.replace('.', ',');
            confirmPaymentMethod.textContent = paymentMethodText;
            confirmCustomer.textContent = customerText;
            confirmCustomerContainer.style.display = customerSearch.value ? 'block' : 'none';
            
            if (isDinheiro) {
                const paid = parseFloat(paymentAmount.value) || 0;
                const change = paid - total;
                confirmPaymentMethod.textContent = `${paymentMethodText} (Pago: R$ ${paid.toFixed(2)}, Troco: R$ ${change.toFixed(2)})`.replace(/\./g, ',');
            }
            
            confirmationModal.show();
        });
        
        // Confirmar venda
        confirmSaleBtn.addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processando...';
            
            const saleData = {
                customer_id: customerId.value || null,
                payment_method_id: parseInt(paymentMethodEl.value),
                items: cart.map(item => ({
                    product_id: parseInt(item.id),
                    quantity: parseInt(item.quantity),
                    price: parseFloat(item.price)
                })),
                discount: parseFloat(discountEl.value) || 0,
                notes: notesEl.value
            };

            console.log('Enviando dados:', saleData);
            
            fetch('{% url "create_sale" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(saleData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                confirmationModal.hide();
                
                if (data.success) {
                    // Limpar carrinho
                    cart = [];
                    updateCartDisplay();
                    
                    // Mostrar Toast de sucesso
                    successToast.show();
                    
                    // Mostrar modal de confirmação
                    Swal.fire({
                        title: 'Venda Realizada!',
                        text: 'A venda foi finalizada com sucesso.',
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonText: 'Ver Detalhes',
                        cancelButtonText: 'Nova Venda',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = `{% url 'sale_detail' 1 %}`.replace('1', data.sale_id);
                        } else {
                            window.location.reload();
                        }
                    });
                } else {
                    throw new Error(data.error || 'Erro ao processar a venda');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                confirmationModal.hide();
                
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Erro ao processar a venda. Tente novamente.',
                    icon: 'error'
                }).then(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'Confirmar Venda';
                });
            });
        });
        
        // Busca de produtos
        productSearch.addEventListener('input', filterProducts);
        categoryFilter.addEventListener('change', filterProducts);
        
        function filterProducts() {
            const searchTerm = productSearch.value.toLowerCase();
            const categoryTerm = categoryFilter.value.toLowerCase();
            
            document.querySelectorAll('.product-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const code = (item.dataset.code || '').toLowerCase();
                const barcode = (item.dataset.barcode || '').toLowerCase();
                const categoryMatch = !categoryTerm || item.dataset.category === categoryTerm;
                const searchMatch = !searchTerm || 
                    name.includes(searchTerm) || 
                    code.includes(searchTerm) || 
                    barcode.includes(searchTerm);
                
                item.style.display = (categoryMatch && searchMatch) ? 'block' : 'none';
            });
        }

        // Busca por código do produto com Enter
        productSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchTerm = this.value.trim().toLowerCase();
                
                // Primeiro tenta encontrar por código exato
                let productItem = Array.from(document.querySelectorAll('.product-item')).find(item => {
                    const code = (item.dataset.code || '').toLowerCase();
                    return code === searchTerm;
                });
                
                if (productItem) {
                    showQuantityModal(productItem);
                    this.value = '';
                }
                
                filterProducts();
            }
        });

        // Busca de clientes
        const customerSuggestions = document.getElementById('customer-suggestions');
        const customers = JSON.parse('{{ customers_json|escapejs }}');

        customerSearch.addEventListener('input', function() {
            const searchTerm = this.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                customerSuggestions.style.display = 'none';
                return;
            }

            const matches = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm)
            );

            if (matches.length > 0) {
                customerSuggestions.innerHTML = matches.map(customer => `
                    <div class="customer-suggestion" data-id="${customer.id}" data-name="${customer.name}">
                        ${customer.name}
                    </div>
                `).join('');
                customerSuggestions.style.display = 'block';
            } else {
                customerSuggestions.style.display = 'none';
            }
        });

        customerSuggestions.addEventListener('click', function(e) {
            const suggestion = e.target.closest('.customer-suggestion');
            if (suggestion) {
                customerSearch.value = suggestion.dataset.name;
                customerId.value = suggestion.dataset.id;
                customerSuggestions.style.display = 'none';
            }
        });

        document.addEventListener('click', function(e) {
            if (!customerSearch.contains(e.target) && !customerSuggestions.contains(e.target)) {
                customerSuggestions.style.display = 'none';
            }
        });
    });
</script>
{% endblock %} 