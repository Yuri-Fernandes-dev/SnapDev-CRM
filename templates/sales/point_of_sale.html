{% extends 'core/base.html' %}

{% block title %}PDV - SaaS CRM{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 8px;
        overflow: hidden;
    }
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .product-name {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 2.4em;
    }
    .product-img-container {
        position: relative;
    }
    .product-img-container::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 10px;
        background: linear-gradient(to top, rgba(255,255,255,0.7), transparent);
    }
    .cart-item {
        border-bottom: 1px solid #e9ecef;
        padding: 0.75rem 0.5rem;
        transition: background-color 0.2s;
        border-radius: 5px;
    }
    .cart-item:hover {
        background-color: #f8f9fa;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    #product-container {
        height: calc(100vh - 200px);
        overflow-y: auto;
        margin-bottom: 1rem;
    }
    .cart-wrapper {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    #cart-container {
        flex: 0 1 auto;
        overflow-y: auto;
        min-height: 150px;
        max-height: 30vh;
        padding: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }
    .cart-summary {
        background: white;
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    .cart-footer {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: white;
    }
    .customer-suggestion {
        cursor: pointer;
        padding: 5px 10px;
    }
    .customer-suggestion:hover {
        background-color: #f8f9fa;
    }
    .total-value {
        font-size: 1.25rem;
        color: #198754;
        font-weight: bold;
    }
    .change-value {
        font-size: 1.1rem;
        color: #0d6efd;
        font-weight: bold;
    }
    .form-group-compact {
        margin-bottom: 0.5rem;
    }
    .form-label-sm {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    .finish-sale-container {
        background: white;
        padding: 1rem;
        border-top: 1px solid #e9ecef;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    .card-body {
        padding-bottom: 1rem;
    }
    .cart-actions {
        padding-bottom: 70px;
    }
    @media (min-width: 1600px) {
        .cart-wrapper {
            height: calc(100vh - 180px);
        }
        #cart-container {
            max-height: 35vh;
        }
    }
    @media (max-width: 1366px) {
        .cart-wrapper {
            height: calc(100vh - 160px);
        }
        #cart-container {
            max-height: 25vh;
        }
        #product-container {
            margin-bottom: 0.5rem;
        }
    }
    @media (max-width: 992px) {
        .cart-wrapper {
            height: auto;
        }
        #cart-container {
            max-height: 25vh;
        }
        .cart-footer {
            max-height: 35vh;
        }
        .finish-sale-container {
            margin-bottom: 2rem;
        }
    }
    .product-section {
        height: calc((100vh - 280px) / 2);
        overflow-y: auto;
        scrollbar-width: thin; /* Para Firefox */
    }
    .product-section::-webkit-scrollbar {
        width: 6px;
    }
    .product-section::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 3px;
    }
    .cart-items-section {
        height: calc((100vh - 280px) / 2);
        overflow-y: auto;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
        scrollbar-width: thin; /* Para Firefox */
    }
    .cart-items-section::-webkit-scrollbar {
        width: 6px;
    }
    .cart-items-section::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 3px;
    }
    /* Ajustes para responsividade */
    @media (max-width: 992px) {
        .product-section,
        .cart-items-section {
            height: 35vh;
        }
    }
    @media (max-width: 768px) {
        .product-section,
        .cart-items-section {
            height: 30vh;
        }
    }
    /* Estilização do select de método de pagamento */
    #payment-method {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s;
    }

    #payment-method:hover {
        background-color: #e9ecef;
        border-color: #ced4da;
    }

    #payment-method:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        border-color: #86b7fe;
        background-color: #fff;
    }

    #payment-method option {
        padding: 10px;
        font-size: 0.9rem;
    }

    #payment-method option:not([disabled]) {
        background-color: #fff;
        color: #212529;
    }

    #payment-method option:hover {
        background-color: #e9ecef;
    }

    /* Estilização dos campos de entrada */
    .form-control-sm, .form-select-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
        border-radius: 0.25rem;
    }

    .form-label-sm {
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 0.3rem;
    }

    /* Container de troco */
    #change-container {
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
    }

    .change-value {
        color: #198754;
        font-weight: 600;
    }

    /* Botão de finalizar venda */
    #finish-sale {
        padding: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .product-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .product-item:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    .product-item td {
        padding: 0.75rem 0.5rem;
    }
    .table-hover tbody tr.product-item:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    /* Product code display fix */
    .product-code {
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: monospace;
        font-size: 0.9rem;
        display: block;
    }
    
    /* Adjustments for table column widths */
    th.code-column {
        width: 80px !important;
    }
    
    td.code-cell {
        padding: 8px 4px !important;
    }
    
    /* Fix for table header display */
    .table thead th {
        background-color: #f8f9fa;
        border-top: none;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }

    /* Destaque para produtos selecionados pelo código */
    .product-item.selected {
        background-color: rgba(25, 135, 84, 0.15) !important;
        outline: 2px solid #198754 !important;
        outline-offset: -2px;
        position: relative;
    }

    .product-item.selected::after {
        content: "✓";
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #198754;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    /* Fade para outros produtos quando um é selecionado */
    .product-item.not-selected {
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Sucesso!</strong> Venda realizada com sucesso!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Alerta de notificação na parte superior -->
<div id="saleAlert" class="alert alert-success alert-dismissible fade show d-none" role="alert" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1050; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
    <i class="fas fa-check-circle me-2"></i> <strong>Venda finalizada!</strong> A venda foi registrada com sucesso.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h1 class="h2 mb-0">Ponto de Venda (PDV)</h1>
        <span class="text-muted ms-3 d-none d-md-inline-flex align-items-center">
            <span class="me-2"><kbd class="bg-light text-secondary border">F1</kbd> busca</span>
            <span class="me-2"><kbd class="bg-light text-secondary border">F2</kbd> pagto</span>
            <span class="me-2"><kbd class="bg-light text-secondary border">F3</kbd> desc</span>
            <span class="me-2"><kbd class="bg-light text-secondary border">F4</kbd> fim</span>
        </span>
        <button type="button" class="btn btn-link ms-1 text-muted p-0" data-bs-toggle="modal" data-bs-target="#shortcutsModal" title="Mais atalhos">
            <i class="fas fa-keyboard"></i>
        </button>
    </div>
    <a href="{% url 'sales:sale_list' %}" class="btn btn-outline-primary">
        <i class="fas fa-list me-1"></i> Histórico de Vendas
    </a>
</div>

<div class="row g-4">
    <!-- Produtos e Carrinho -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 py-3">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="product-search" class="form-control" placeholder="Digite o código do produto...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="category-filter" class="form-select">
                            <option value="">Todas as categorias</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="barcode-scan" class="btn btn-primary w-100">
                            <i class="fas fa-barcode"></i> Scan
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                <!-- Produtos -->
                <div class="product-section p-3">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="products-grid">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px">Imagem</th>
                                    <th class="code-column">Código</th>
                                    <th>Produto</th>
                                    <th style="width: 100px">Preço</th>
                                    <th style="width: 70px">Estoque</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr class="product-item" 
                                    data-id="{{ product.id }}" 
                                    data-name="{{ product.name }}" 
                                    data-price="{{ product.price }}" 
                                    data-stock="{{ product.stock_quantity }}"
                                    data-code="{{ product.code }}"
                                    data-barcode="{{ product.barcode }}"
                                    data-category="{{ product.category.name }}">
                                    <td>
                                        {% if product.image %}
                                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                <i class="fas fa-tshirt text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="code-cell"><span class="product-code" title="{{ product.code }}">{{ product.code|default:"-" }}</span></td>
                                    <td>
                                        <div class="fw-medium">{{ product.name }}</div>
                                        {% if product.has_variations %}
                                        <small class="text-muted">Com variações</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">R$ {{ product.price }}</span>
                                    </td>
                                    <td>
                                        {% if product.stock_quantity <= product.stock_alert_level %}
                                        <span class="badge bg-danger">{{ product.stock_quantity }}</span>
                                        {% else %}
                                        <span class="badge bg-light text-dark border">{{ product.stock_quantity }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <p class="mb-0 text-muted">Nenhum produto encontrado. <a href="{% url 'products:product_create' %}">Cadastre um produto</a>.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Itens do Carrinho -->
                <div class="cart-items-section p-3">
                    <h6 class="mb-3">
                        <i class="fas fa-shopping-cart me-2"></i>Itens no Carrinho
                    </h6>
                    <div id="cart-items">
                        <div class="text-center text-muted py-4" id="empty-cart-message">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p class="mb-0">Adicione produtos ao carrinho</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumo e Finalização -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="cart-wrapper">
                    <div class="cart-summary">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Subtotal:</span>
                            <span class="fw-bold" id="subtotal">R$ 0,00</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Desconto:</span>
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <input type="number" id="discount" class="form-control" value="0" min="0" step="0.01">
                                <span class="input-group-text">R$</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Total:</span>
                            <span class="total-value" id="total">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <div class="cart-footer">
                        <div class="cart-actions">
                            <div class="form-group-compact">
                                <label for="payment-method" class="form-label-sm">Método de Pagamento</label>
                                <select id="payment-method" class="form-select form-select-sm">
                                    <option value="" disabled selected>Selecione o método de pagamento</option>
                                    {% for method in payment_methods %}
                                    <option value="{{ method.id }}" data-type="{{ method.name|lower }}">
                                        {% if method.name == 'Dinheiro' %}💵
                                        {% elif method.name == 'Cartão de Crédito' %}💳
                                        {% elif method.name == 'Cartão de Débito' %}💳
                                        {% elif method.name == 'PIX' %}📱
                                        {% endif %}
                                        {{ method.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div id="change-container" style="display: none;" class="form-group-compact mt-2">
                                <label for="payment-amount" class="form-label-sm">Valor Pago</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" id="payment-amount" class="form-control" step="0.01" min="0">
                                </div>
                                <div class="mt-1">
                                    <small>Troco: <span class="change-value" id="change-amount">R$ 0,00</span></small>
                                </div>
                            </div>
                            
                            <div class="form-group-compact mt-3">
                                <label for="customer-search" class="form-label-sm">
                                    <i class="fas fa-user me-1"></i>Cliente (opcional)
                                </label>
                                <div class="position-relative">
                                    <input type="text" id="customer-search" class="form-control form-control-sm" placeholder="Digite o nome do cliente...">
                                    <input type="hidden" id="customer-id">
                                    <div id="customer-suggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display: none; z-index: 1000; max-height: 150px; overflow-y: auto;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group-compact mt-3">
                                <label for="notes" class="form-label-sm">
                                    <i class="fas fa-sticky-note me-1"></i>Observações
                                </label>
                                <textarea id="notes" class="form-control form-control-sm" rows="2" placeholder="Adicione observações sobre a venda..."></textarea>
                            </div>

                            <div class="finish-sale-container">
                                <div class="d-grid">
                                    <button id="finish-sale" class="btn btn-success">
                                        <i class="fas fa-check-circle me-1"></i> Finalizar Venda
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Quantidade -->
<div class="modal fade" id="quantityModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-product-name">Nome do Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-to-cart-form" onsubmit="document.getElementById('add-to-cart').click(); return false;">
                <div class="modal-body">
                    <p class="mb-3">Preço: <span class="fw-bold" id="modal-product-price">R$ 0,00</span></p>
                    <p class="mb-3">Estoque disponível: <span class="fw-bold" id="modal-product-stock">0</span></p>
                    
                    <div class="mb-3">
                        <label for="product-quantity" class="form-label">Quantidade</label>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" id="decrease-qty">-</button>
                            <input type="number" id="product-quantity" class="form-control text-center" value="1" min="1">
                            <button type="button" class="btn btn-outline-secondary" id="increase-qty">+</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="add-to-cart">Adicionar ao Carrinho</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Total a pagar: <span class="fw-bold" id="confirm-total">R$ 0,00</span></p>
                <p>Método de pagamento: <span id="confirm-payment-method">Dinheiro</span></p>
                <p id="confirm-customer-container">Cliente: <span id="confirm-customer">-</span></p>
                
                <div class="mt-3 form-check">
                    <input class="form-check-input" type="checkbox" id="send-whatsapp-receipt" disabled>
                    <label class="form-check-label" for="send-whatsapp-receipt">
                        <i class="fab fa-whatsapp text-success me-1"></i> Enviar recibo por WhatsApp
                    </label>
                    <small class="form-text text-muted d-block">
                        Apenas disponível se o cliente tiver telefone cadastrado
                    </small>
                </div>
                
                <div class="alert alert-success mt-3" id="sale-success-message" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i> Venda realizada com sucesso!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a class="btn btn-outline-primary" style="display: none;" id="view-sales-history" data-bs-dismiss="modal">
                    <i class="fas fa-check me-1"></i> Fechar
                </a>
                <button type="button" class="btn btn-primary" id="confirm-sale">Confirmar Venda</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Atalhos de Teclado -->
<div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shortcutsModalLabel">
                    <i class="fas fa-keyboard me-2"></i> Atalhos de Teclado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th style="width: 100px">Tecla</th>
                                <th>Função</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><kbd>F1</kbd></td>
                                <td>Focar na busca de produtos</td>
                            </tr>
                            <tr>
                                <td><kbd>F2</kbd></td>
                                <td>Focar no método de pagamento</td>
                            </tr>
                            <tr>
                                <td><kbd>F3</kbd></td>
                                <td>Focar no campo de desconto</td>
                            </tr>
                            <tr>
                                <td><kbd>F4</kbd></td>
                                <td>Finalizar venda</td>
                            </tr>
                            <tr>
                                <td><kbd>↑</kbd> / <kbd>↓</kbd></td>
                                <td>Navegar entre produtos</td>
                            </tr>
                            <tr>
                                <td><kbd>Enter</kbd></td>
                                <td>Selecionar produto / confirmar</td>
                            </tr>
                            <tr>
                                <td><kbd>Esc</kbd></td>
                                <td>Limpar campo de busca</td>
                            </tr>
                            <tr>
                                <td><kbd>Alt</kbd>+<kbd>X</kbd></td>
                                <td>Limpar carrinho</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Array para armazenar itens do carrinho
    let cart = [];
    
    // Função para renderizar os itens do carrinho
    function renderCartItems() {
        const cartItems = document.getElementById('cart-items');
        
        if (cart.length === 0) {
            cartItems.innerHTML = `
                <div class="text-center text-muted py-4" id="empty-cart-message">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <p class="mb-0">Adicione produtos ao carrinho</p>
                </div>
            `;
            return;
        }
        
        let cartHtml = '';
        cart.forEach((item, index) => {
            cartHtml += `
                <div class="cart-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded bg-white shadow-sm">
                    <div>
                        <div class="fw-medium mb-1">${item.name}</div>
                        <div class="d-flex align-items-center text-muted small">
                            <span class="badge bg-light text-dark me-2">${item.quantity}x</span>
                            <span>R$ ${item.price}</span>
                            <span class="mx-1">•</span>
                            <span class="text-success fw-bold">Total: R$ ${(item.quantity * item.price).toFixed(2)}</span>
                        </div>
                        <div class="small text-muted mt-1">Código: ${item.code}</div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-danger rounded-circle" onclick="removeCartItem(${index})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        cartItems.innerHTML = cartHtml;
    }
    
    // Função para calcular e atualizar os totais
    function updateTotals() {
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        const discountEl = document.getElementById('discount');
        
        let subtotal = 0;
        cart.forEach(item => {
            subtotal += item.quantity * item.price;
        });
        
        const discount = parseFloat(discountEl.value) || 0;
        const total = Math.max(0, subtotal - discount);
        
        subtotalEl.textContent = `R$ ${subtotal.toFixed(2)}`;
        totalEl.textContent = `R$ ${total.toFixed(2)}`;
        
        // Atualizar o total no modal de confirmação
        if (document.getElementById('confirm-total')) {
            document.getElementById('confirm-total').textContent = `R$ ${total.toFixed(2)}`;
        }
    }
    
    // Função para remover item do carrinho
    window.removeCartItem = function(index) {
        if (index >= 0 && index < cart.length) {
            cart.splice(index, 1);
            renderCartItems();
            updateTotals();
        }
    };

    // Garantir que o evento seja configurado quando o documento estiver totalmente carregado
    document.addEventListener('DOMContentLoaded', function() {
        // Remover event listener anterior se existir (com tratamento de erro)
        try {
            document.removeEventListener('keydown', handleShortcutKeys);
        } catch (e) {
            // Ignora o erro se o listener não existir
        }
        
        // Adicionar event listener global para atalhos
        document.addEventListener('keydown', handleShortcutKeys);
        
        // Focar no campo de busca ao carregar a página
        const searchInput = document.getElementById('product-search');
        searchInput.value = '';
        searchInput.focus();

        // Configurar a busca de produtos
        setupProductSearch();

        // Configurar o método de pagamento para mostrar o campo de valor pago quando Dinheiro for selecionado
        const paymentMethodSelect = document.getElementById('payment-method');
        paymentMethodSelect.addEventListener('change', function() {
            console.log('Método de pagamento alterado:', this.options[this.selectedIndex].textContent.trim());
            const paymentMethod = this.options[this.selectedIndex].textContent.trim();
            const changeContainer = document.getElementById('change-container');
            
            if (paymentMethod.includes('Dinheiro')) {
                changeContainer.style.display = 'block';
                document.getElementById('payment-amount').focus();
            } else {
                changeContainer.style.display = 'none';
            }
        });
        
        // Configurar o cálculo de troco
        document.getElementById('payment-amount').addEventListener('input', function() {
            const totalText = document.getElementById('total').textContent.trim();
            const total = parseFloat(totalText.replace('R$', '').replace(',', '.')) || 0;
            const paymentAmount = parseFloat(this.value) || 0;
            const changeAmount = Math.max(0, paymentAmount - total);
            
            console.log('Calculando troco:', total, paymentAmount, changeAmount);
            document.getElementById('change-amount').textContent = `R$ ${changeAmount.toFixed(2)}`;
        });

        // Configurar a busca de clientes por AJAX
        const customerSearch = document.getElementById('customer-search');
        const customerSuggestions = document.getElementById('customer-suggestions');
        const customerId = document.getElementById('customer-id');
        
        customerSearch?.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            if (searchTerm.length < 2) {
                customerSuggestions.style.display = 'none';
                customerId.value = '';
                this.classList.remove('is-valid');
                return;
            }
            
            // Buscar clientes via AJAX
            fetch(`/sistema/clientes/busca-ajax/?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        // Mostrar sugestões
                        let suggestionsHtml = '';
                        data.results.forEach(customer => {
                            suggestionsHtml += `
                                <div class="customer-suggestion p-2 border-bottom" 
                                    data-id="${customer.id}" 
                                    data-name="${customer.name}"
                                    data-has-phone="${customer.has_phone}">
                                    <div class="fw-medium">${customer.text}</div>
                                </div>
                            `;
                        });
                        
                        customerSuggestions.innerHTML = suggestionsHtml;
                        customerSuggestions.style.display = 'block';
                        
                        // Adicionar evento de clique às sugestões
                        document.querySelectorAll('.customer-suggestion').forEach(suggestion => {
                            suggestion.addEventListener('click', function() {
                                const id = this.getAttribute('data-id');
                                const name = this.getAttribute('data-name');
                                const hasPhone = this.getAttribute('data-has-phone') === 'true';
                                
                                customerSearch.value = name;
                                customerId.value = id;
                                customerSuggestions.style.display = 'none';
                                customerSearch.classList.add('is-valid');
                                
                                // Atualizar modal de confirmação
                                if (document.getElementById('confirm-customer')) {
                                    document.getElementById('confirm-customer').textContent = name;
                                    document.getElementById('confirm-customer-container').style.display = 'block';
                                }
                                
                                // Habilitar opção de WhatsApp se o cliente tiver telefone
                                const whatsappCheck = document.getElementById('send-whatsapp-receipt');
                                if (whatsappCheck) {
                                    whatsappCheck.disabled = !hasPhone;
                                    whatsappCheck.checked = false; // Sempre começa desmarcado
                                }
                            });
                        });
                    } else {
                        // Nenhum cliente encontrado - oferecer opção de cadastro
                        customerSuggestions.innerHTML = `
                            <div class="p-2 text-primary new-customer-option" style="cursor: pointer;">
                                <i class="fas fa-plus-circle me-1"></i> Cadastrar novo cliente "${searchTerm}"
                            </div>
                        `;
                        customerSuggestions.style.display = 'block';
                        
                        // Adicionar evento para cadastro de novo cliente
                        document.querySelector('.new-customer-option')?.addEventListener('click', function() {
                            window.open('/sistema/clientes/novo/?name=' + encodeURIComponent(searchTerm), '_blank');
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro na busca de clientes:', error);
                    customerSuggestions.style.display = 'none';
                });
        });
        
        // Fechar sugestões ao clicar fora
        document.addEventListener('click', function(e) {
            if (!customerSearch?.contains(e.target) && !customerSuggestions?.contains(e.target)) {
                customerSuggestions.style.display = 'none';
            }
        });

        // Adicionar botão para limpar a seleção de cliente
        const customerField = document.querySelector('.position-relative');
        const clearButton = document.createElement('button');
        clearButton.className = 'btn btn-sm btn-link position-absolute top-50 end-0 translate-middle-y text-muted';
        clearButton.innerHTML = '<i class="fas fa-times"></i>';
        clearButton.style.display = 'none';
        clearButton.style.zIndex = '1001';
        clearButton.title = 'Limpar cliente selecionado';
        
        customerField.appendChild(clearButton);
        
        // Mostrar/esconder o botão limpar quando necessário
        customerSearch.addEventListener('input', function() {
            clearButton.style.display = this.value ? 'block' : 'none';
        });
        
        // Limpar seleção ao clicar no botão
        clearButton.addEventListener('click', function() {
            customerSearch.value = '';
            customerId.value = '';
            customerSearch.classList.remove('is-valid');
            customerSuggestions.style.display = 'none';
            clearButton.style.display = 'none';
            customerSearch.focus();
            
            // Atualizar modal de confirmação
            if (document.getElementById('confirm-customer')) {
                document.getElementById('confirm-customer').textContent = '-';
            }
            
            // Desabilitar opção de WhatsApp
            document.getElementById('send-whatsapp-receipt').disabled = true;
            document.getElementById('send-whatsapp-receipt').checked = false;
        });
        
        // Fechar sugestões ao clicar fora
        document.addEventListener('click', function(e) {
            if (!customerSearch.contains(e.target) && !customerSuggestions.contains(e.target)) {
                customerSuggestions.style.display = 'none';
            }
        });

        // Adicionar estilo CSS para a sugestão ativa
        const style = document.createElement('style');
        style.textContent = `
            .customer-suggestion.active {
                background-color: #f8f9fa;
                border-left: 3px solid #198754;
            }
            .customer-suggestion:hover {
                background-color: #f8f9fa;
            }
            #customer-search.is-valid {
                background-color: #f8fff9;
                border-color: #198754;
            }
        `;
        document.head.appendChild(style);

        // Configurar o modal de quantidade
        setupQuantityModal();
    });

    // Função para configurar a busca de produtos
    function setupProductSearch() {
        const searchInput = document.getElementById('product-search');
        const productsTable = document.getElementById('products-grid');
        let selectedRow = null;

        // Função para limpar todas as seleções
        function clearAllSelections() {
            const allRows = productsTable.querySelectorAll('tbody tr.product-item');
            allRows.forEach(row => {
                row.classList.remove('selected');
                row.classList.remove('not-selected');
                row.style.outline = '';
            });
            selectedRow = null;
        }

        // Função para resetar e mostrar todos os produtos
        function resetProductDisplay() {
            // Mostrar todos os produtos
            const allRows = productsTable.querySelectorAll('tbody tr.product-item');
            allRows.forEach(row => {
                row.style.display = '';
            });
            
            // Limpar seleções
            clearAllSelections();
            
            // Limpar campo de busca
            searchInput.value = '';
        }

        // Evento de input para filtrar produtos
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            // Limpar seleção anterior e resetar exibição
            clearAllSelections();
            
            // Reset completo se a busca estiver vazia
                if (!searchTerm) {
                resetProductDisplay();
                return;
            }
            
            // Filtrar produtos
            const rows = productsTable.querySelectorAll('tbody tr.product-item');
            let visibleRows = [];
            let exactMatch = null;
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name').toLowerCase();
                const code = row.getAttribute('data-code').toLowerCase();
                const barcode = row.getAttribute('data-barcode')?.toLowerCase() || '';
                
                // Verificar correspondência exata com código
                if (code === searchTerm) {
                    exactMatch = row;
                }
                
                if (name.includes(searchTerm) || code.includes(searchTerm) || barcode.includes(searchTerm)) {
                    row.style.display = '';
                    visibleRows.push(row);
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Se houver correspondência exata, selecionar esse produto
            if (exactMatch) {
                selectedRow = exactMatch;
                selectedRow.classList.add('selected');
                selectedRow.style.outline = '2px solid #198754';
                selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Se for uma correspondência exata, abrir o modal automaticamente
                if (searchTerm.length > 2) {
                    selectProduct(exactMatch);
                }
            }
            // Caso contrário, destacar o primeiro produto visível se houver apenas um
            else if (visibleRows.length === 1) {
                selectedRow = visibleRows[0];
                selectedRow.classList.add('selected');
                selectedRow.style.outline = '2px solid #198754';
                selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Marcar outros produtos como não selecionados se houver seleção
            if (selectedRow) {
                visibleRows.forEach(row => {
                    if (row !== selectedRow) {
                        row.classList.add('not-selected');
                    }
                });
            }
        });
        
        // Evento de tecla para o campo de busca
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // Selecionar produto destacado ou primeiro visível
                const rows = Array.from(productsTable.querySelectorAll('tbody tr.product-item')).filter(row => row.style.display !== 'none');
                
                if (rows.length > 0) {
                    // Se não há produto selecionado, selecione o primeiro
                    const selectedProduct = selectedRow || rows[0];
                    selectProduct(selectedProduct);
                    
                    // Limpar campo após selecionar para a próxima busca
                    this.value = '';
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateProductList('down');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateProductList('up');
            } else if (e.key === 'Escape') {
                e.preventDefault();
                resetProductDisplay();
            }
        });
        
        // Adicionar eventos de clique aos produtos
        const productItems = productsTable.querySelectorAll('tbody tr.product-item');
        productItems.forEach(item => {
            item.addEventListener('click', function() {
                // Limpar seleções anteriores
                clearAllSelections();
                
                // Selecionar o produto clicado
                this.classList.add('selected');
                this.style.outline = '2px solid #198754';
                selectedRow = this;
                
                // Selecionar o produto
                selectProduct(this);
            });
        });
    }
    
    // Função para navegar na lista de produtos com as setas
    function navigateProductList(direction) {
        const rows = Array.from(document.querySelectorAll('#products-grid tbody tr.product-item')).filter(row => row.style.display !== 'none');
        
        if (rows.length === 0) return;
        
        let selectedIndex = -1;
        
        // Encontrar índice do produto selecionado
        rows.forEach((row, index) => {
            if (row.classList.contains('selected')) {
                selectedIndex = index;
                row.classList.remove('selected');
                row.style.outline = '';
            }
            // Remover classe not-selected de todos
            row.classList.remove('not-selected');
        });
        
        if (direction === 'down') {
            selectedIndex = (selectedIndex + 1) % rows.length;
        } else if (direction === 'up') {
            selectedIndex = selectedIndex <= 0 ? rows.length - 1 : selectedIndex - 1;
        }
        
        // Aplicar seleção ao produto correto
        rows[selectedIndex].classList.add('selected');
        rows[selectedIndex].style.outline = '2px solid #198754';
        rows[selectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Marcar outros produtos como não selecionados
        rows.forEach((row, index) => {
            if (index !== selectedIndex) {
                row.classList.add('not-selected');
            }
        });
    }
    
    // Função para selecionar um produto e abrir o modal de quantidade
    function selectProduct(productRow) {
        const id = productRow.getAttribute('data-id');
        const name = productRow.getAttribute('data-name');
        const price = parseFloat(productRow.getAttribute('data-price'));
        const stock = parseInt(productRow.getAttribute('data-stock'));
        const code = productRow.getAttribute('data-code');
        
        // Atualizar dados no modal
        document.getElementById('modal-product-name').textContent = name;
        document.getElementById('modal-product-price').textContent = `R$ ${price.toFixed(2)}`;
        document.getElementById('modal-product-stock').textContent = stock;
        document.getElementById('product-quantity').value = 1;
        
        // Armazenar dados do produto selecionado para adicionar ao carrinho
        const addToCartBtn = document.getElementById('add-to-cart');
        addToCartBtn.setAttribute('data-id', id);
        addToCartBtn.setAttribute('data-name', name);
        addToCartBtn.setAttribute('data-price', price);
        addToCartBtn.setAttribute('data-code', code);
        
        // Remover qualquer backdrop anterior para evitar escurecimento progressivo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
        
        // Abrir o modal e impedir disparos repetidos
        const quantityModal = document.getElementById('quantityModal');
        // Verificar se o modal já está sendo mostrado para evitar aberturas repetidas
        if (!quantityModal.classList.contains('show')) {
            const modal = new bootstrap.Modal(quantityModal);
            modal.show();
            
            // Aguardar a animação do modal terminar antes de focar no campo de quantidade
            setTimeout(() => {
                document.getElementById('product-quantity').focus();
                document.getElementById('product-quantity').select();
            }, 300);
        }
    }

    // Função para gerenciar atalhos de teclado
    function handleShortcutKeys(e) {
        // Evitar atalhos se algum modal estiver aberto
        if (document.querySelector('.modal.show')) {
                return;
            }
            
        // F1 - Focar no campo de busca de produtos
        if (e.key === 'F1') {
            e.preventDefault();
            const searchInput = document.getElementById('product-search');
            searchInput.value = '';
            searchInput.focus();
            searchInput.select();
            return false;
        }
        
        // F2 - Focar no método de pagamento
        else if (e.key === 'F2') {
            e.preventDefault();
            document.getElementById('payment-method').focus();
        }
        
        // F3 - Focar no campo de desconto
        else if (e.key === 'F3') {
            e.preventDefault();
            document.getElementById('discount').focus();
        }
        
        // F4 - Finalizar a venda (se houver produtos no carrinho)
        else if (e.key === 'F4') {
            e.preventDefault();
            if (cart.length > 0) {
                document.getElementById('finish-sale').click();
                } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Carrinho Vazio',
                    text: 'Adicione produtos ao carrinho antes de finalizar a venda.',
                    confirmButtonText: 'OK'
                });
            }
        }
    }

    // Configurar o botão finalizar venda
    document.getElementById('finish-sale').addEventListener('click', function(e) {
        // Verificar se há itens no carrinho
        if (cart.length === 0) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Carrinho Vazio',
                text: 'Adicione produtos ao carrinho antes de finalizar a venda.',
                confirmButtonText: 'OK'
            });
            return false;
        }
        
        // Verificar método de pagamento
        const paymentMethodEl = document.getElementById('payment-method');
        const paymentMethod = paymentMethodEl.options[paymentMethodEl.selectedIndex];
        if (!paymentMethod || paymentMethod.value === '') {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Método de Pagamento',
                text: 'Selecione um método de pagamento antes de finalizar.',
                confirmButtonText: 'OK'
            });
            paymentMethodEl.focus();
            return false;
        }
        
        // Preencher os dados no modal de confirmação
        document.getElementById('confirm-total').textContent = document.getElementById('total').textContent;
        document.getElementById('confirm-payment-method').textContent = paymentMethod.textContent.trim();
        
        // Cliente selecionado
        const customerId = document.getElementById('customer-id').value;
        const customerName = document.getElementById('customer-search').value;
        if (customerId && customerName) {
            document.getElementById('confirm-customer').textContent = customerName;
            document.getElementById('confirm-customer-container').style.display = 'block';
        } else {
            document.getElementById('confirm-customer').textContent = '-';
            document.getElementById('confirm-customer-container').style.display = 'block';
        }
        
        // Abrir o modal de confirmação
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
    });

    // Configurar o botão de confirmar venda no modal
    document.getElementById('confirm-sale').addEventListener('click', function() {
        // Desabilitar o botão durante o processamento
            this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processando...';
        
        // Preparar os dados da venda
        const items = [];
        cart.forEach(item => {
            items.push({
                    product_id: item.id,
                    quantity: item.quantity,
                    price: item.price
            });
        });
        
        const saleData = {
            customer_id: document.getElementById('customer-id').value || null,
            payment_method: document.getElementById('payment-method').value,
            items: items,
            discount: parseFloat(document.getElementById('discount').value) || 0,
            notes: document.getElementById('notes').value || '',
            send_whatsapp: document.getElementById('send-whatsapp-receipt').checked
        };

        // Enviar a venda para o servidor via AJAX
        fetch("{% url 'sales:confirm_sale' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(saleData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                    throw new Error(data.error || 'Erro ao processar a venda');
                    });
                }
                return response.json();
            })
            .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Erro ao processar a venda');
            }
            console.log("Venda registrada com sucesso:", data);
                
            // Limpar o PDV imediatamente após o sucesso
            resetPDV();
                
                // Mostrar mensagem de sucesso
            document.getElementById('sale-success-message').style.display = 'block';
                
            // Esconder botão de confirmar e mostrar botão de fechar
            this.style.display = 'none';
            document.getElementById('view-sales-history').style.display = 'inline-block';
            document.getElementById('view-sales-history').href = "{% url 'sales:sale_list' %}";
                
            // Mostrar toast de confirmação
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
                
            // Ativar fechamento do modal com Enter
            activateSuccessCloseWithEnter();
                
            // Se tiver uma URL de recibo e o cliente escolheu enviar por WhatsApp
            if (data.has_phone && saleData.send_whatsapp) {
                    setTimeout(() => {
                    window.open(`/sistema/vendas/${data.sale_id}/whatsapp/`, '_blank');
                }, 500);
            }

            // Fechar o modal após um breve delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
                    
                // Mostrar alerta de sucesso
                Swal.fire({
                    icon: 'success',
                    title: 'Venda Realizada',
                    text: 'A venda foi registrada com sucesso!',
                    timer: 2000,
                    showConfirmButton: false
                });
            }, 500);
            })
            .catch(error => {
            console.error('Erro:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erro na Venda',
                text: error.message || 'Ocorreu um erro ao processar a venda. Por favor, tente novamente.',
                confirmButtonText: 'OK'
            });
            
            // Restaurar o botão
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check-circle me-1"></i> Confirmar Venda';
            });
        });

    // Configurar o desconto para atualizar totais
    document.getElementById('discount').addEventListener('input', updateTotals);

    // Configurar o manipulador para Enter no modal de confirmação
    document.getElementById('confirmationModal').addEventListener('shown.bs.modal', function() {
        // Desativar temporariamente o event listener global de atalhos
        document.removeEventListener('keydown', handleShortcutKeys);
        
        // Criar uma função global para lidar com o Enter
        window.handleConfirmEnter = function(event) {
            if (event.key === 'Enter' && !event.repeat) {
                event.preventDefault();
                event.stopPropagation();
                const confirmButton = document.getElementById('confirm-sale');
                if (!confirmButton.disabled) {
                    confirmButton.click();
                }
                return false;
            }
        };
        
        // Adicionar o event listener global
        document.addEventListener('keydown', window.handleConfirmEnter);
    });
    
    document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', function() {
        // Remover o event listener específico do modal
        if (window.handleConfirmEnter) {
            document.removeEventListener('keydown', window.handleConfirmEnter);
        }
        // Reativar o event listener global de atalhos
        document.addEventListener('keydown', handleShortcutKeys);
    });

    // Quando o processamento da venda for concluído com sucesso e mostrarmos o botão de fechar
    // Adicionar um event listener para permitir o fechamento com Enter
    function activateSuccessCloseWithEnter() {
        window.handleSuccessEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.stopPropagation();
                // Clicar no botão de ver histórico (fechar)
                document.getElementById('view-sales-history').click();
                return false;
            }
        };
        
        // Adicionar o event listener global
        document.addEventListener('keydown', window.handleSuccessEnter);
    }

    // Função para resetar o PDV
    function resetPDV() {
        // Limpar o carrinho
        cart = [];
            renderCartItems();
            updateTotals();

        // Resetar campos de entrada
        document.getElementById('product-search').value = '';
        document.getElementById('discount').value = '0';
        document.getElementById('payment-method').selectedIndex = 0;
        document.getElementById('customer-search').value = '';
        document.getElementById('customer-id').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('payment-amount').value = '';

        // Remover classe de validação do campo de cliente
        document.getElementById('customer-search').classList.remove('is-valid');

        // Esconder elementos relacionados ao troco
        document.getElementById('change-container').style.display = 'none';
        document.getElementById('change-amount').textContent = 'R$ 0,00';

        // Remover listeners específicos dos modais
        if (window.handleConfirmEnter) {
            document.removeEventListener('keydown', window.handleConfirmEnter);
            window.handleConfirmEnter = null;
        }
        if (window.handleSuccessEnter) {
            document.removeEventListener('keydown', window.handleSuccessEnter);
            window.handleSuccessEnter = null;
        }

        // Esconder botão de limpar cliente
        const clearButton = document.querySelector('.position-relative button');
        if (clearButton) {
            clearButton.style.display = 'none';
        }

        // Resetar estado do botão finalizar venda
        const finishSaleBtn = document.getElementById('finish-sale');
        if (finishSaleBtn) {
            finishSaleBtn.disabled = false;
            finishSaleBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Finalizar Venda';
        }

        // Resetar estado do botão confirmar venda no modal
        const confirmSaleBtn = document.getElementById('confirm-sale');
        if (confirmSaleBtn) {
            confirmSaleBtn.disabled = false;
            confirmSaleBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Confirmar Venda';
        }
        
        // Reativar manipuladores de atalhos globais
        document.removeEventListener('keydown', handleShortcutKeys);
        document.addEventListener('keydown', handleShortcutKeys);
    }

    // Configurar o botão de adicionar ao carrinho
    document.getElementById('add-to-cart').addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const name = this.getAttribute('data-name');
        const price = parseFloat(this.getAttribute('data-price'));
        const code = this.getAttribute('data-code');
        const quantity = parseInt(document.getElementById('product-quantity').value) || 1;
        
        // Validar quantidade
        if (quantity < 1) {
            Swal.fire({
                icon: 'warning',
                title: 'Quantidade Inválida',
                text: 'A quantidade deve ser no mínimo 1.',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        const stock = parseInt(document.getElementById('modal-product-stock').textContent);
        if (quantity > stock) {
            Swal.fire({
                icon: 'warning',
                title: 'Estoque Insuficiente',
                text: `Estoque insuficiente. Disponível: ${stock}`,
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Adicionar ao carrinho
        cart.push({
            id: id,
            name: name,
            price: price,
            quantity: quantity,
            code: code
        });
        
        // Atualizar interface
        renderCartItems();
        updateTotals();
        
        // Fechar modal
        bootstrap.Modal.getInstance(document.getElementById('quantityModal')).hide();
        
        // Remover backdrops para evitar escurecimento progressivo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
        
        // Limpar seleções e reexibir todos os produtos
        const productsTable = document.getElementById('products-grid');
        const allRows = productsTable.querySelectorAll('tbody tr.product-item');
        allRows.forEach(row => {
            row.classList.remove('selected');
            row.classList.remove('not-selected');
            row.style.outline = '';
            row.style.display = '';
        });
        
        // Limpar e focar no campo de busca
        const searchInput = document.getElementById('product-search');
        searchInput.value = '';
        searchInput.focus();
    });

    // Configurar a captura da tecla Enter no modal de quantidade
    document.getElementById('quantityModal').addEventListener('shown.bs.modal', function() {
        const quantityInput = document.getElementById('product-quantity');
        quantityInput.focus();
        quantityInput.select();
        
        // Desabilitar temporariamente os atalhos globais
        document.removeEventListener('keydown', handleShortcutKeys);
        
        // Configurar os botões + e - para aumentar/diminuir quantidade
        document.getElementById('increase-qty').onclick = function() {
            let currentValue = parseInt(quantityInput.value) || 0;
            quantityInput.value = currentValue + 1;
        };
        
        document.getElementById('decrease-qty').onclick = function() {
            let currentValue = parseInt(quantityInput.value) || 0;
            quantityInput.value = Math.max(1, currentValue - 1);
        };
        
        // Permitir usar setas para aumentar/diminuir quantidade
        quantityInput.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                let value = parseInt(this.value) || 0;
                this.value = value + 1;
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                let value = parseInt(this.value) || 0;
                this.value = Math.max(1, value - 1);
            }
        });
    });
    
    document.getElementById('quantityModal').addEventListener('hidden.bs.modal', function() {
        // Reativar atalhos globais quando o modal é fechado
        document.addEventListener('keydown', handleShortcutKeys);
        
        // Remover backdrops para evitar escurecimento progressivo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
    });
</script>
</div>
{% endblock %} 